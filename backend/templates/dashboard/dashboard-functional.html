<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TaskGrid ‚Äî Dashboard</title>
<style>
  :root{
    --bg:#0c1022;
    --bg2:#0a0e1d;
    --card:rgba(255,255,255,.06);
    --card-deep:rgba(255,255,255,.08);
    --muted:#a6b0d1;
    --text:#e9ecff;
    --accent1:#06d7ff;
    --accent2:#7b2cff;
    --ok:#2ad39a;
    --warn:#ffb020;
    --bad:#ff5d6c;
    --ring: 0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.45);
  }

  /* Page */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    font:15px/1.45 "Segoe UI",Inter,system-ui,-apple-system,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 70% -10%, #1a2042 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 20%, #12183a 0%, transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    overflow:hidden;
  }

  /* Subtle starfield dots */
  .dots{position:fixed; inset:0; pointer-events:none; opacity:.35}
  .dots::before,.dots::after{
    content:""; position:absolute; inset:-20%;
    background-image:
      radial-gradient(#8ad 1px, transparent 1px),
      radial-gradient(#6cf 1px, transparent 1px),
      radial-gradient(#9bf 1px, transparent 1px);
    background-size: 120px 120px, 180px 180px, 240px 240px;
    background-position: 0 0, 40px 60px, 100px 20px;
    filter: blur(.2px);
    animation: drift 60s linear infinite;
  }
  .dots::after{animation-duration:85s; opacity:.8}
  @keyframes drift{to{transform:translateY(80px)}}

  /* App shell */
  .app{display:grid; grid-template-columns: 260px 1fr 330px; grid-template-rows: 72px 1fr; height:100%}

  .topbar{
    grid-column:1 / -1;
    display:flex; align-items:center; gap:16px;
    padding:12px 18px;
    border-bottom:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; align-items:center; gap:10px; margin-right:auto}
  .logo{
    width:36px; height:36px; border-radius:10px;
    background:linear-gradient(135deg, var(--accent1), var(--accent2));
    display:grid; place-items:center; font-weight:800
  }
  .brand h1{font-size:16px; margin:0; letter-spacing:.4px; opacity:.95}
  .role-badge{
    padding:6px 10px; border-radius:999px;
    background:linear-gradient(90deg, rgba(6,215,255,.15), rgba(123,44,255,.15));
    border:1px solid rgba(123,44,255,.35);
    font-size:12px; letter-spacing:.3px
  }
  .top-actions{display:flex; align-items:center; gap:10px}
  .btn, .btn-ghost{
    padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600; color:var(--text)
  }
  .btn{
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    box-shadow:0 8px 24px rgba(123,44,255,.3)
  }
  .btn-ghost{background:rgba(255,255,255,.06)}
  .select{
    appearance:none; background:rgba(255,255,255,.06); border:0; color:var(--text);
    padding:10px 36px 10px 12px; border-radius:12px; font-weight:600; position:relative
  }

  /* Sidebar */
  .side{
    padding:16px; border-right:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.15); backdrop-filter: blur(8px)
  }
  .menu{display:flex; flex-direction:column; gap:8px}
  .menu h3{margin:10px 8px 6px; color:#b8c1ea; font-size:12px; letter-spacing:.15em; text-transform:uppercase}
  .item{
    padding:12px 12px; border-radius:12px; background:transparent; color:var(--text); text-decoration:none; display:flex; align-items:center; gap:10px; cursor:pointer;
  }
  .item.active, .item:hover{
    background:linear-gradient(90deg, rgba(6,215,255,.12), rgba(123,44,255,.12));
    box-shadow:0 1px 0 0 rgba(255,255,255,.04) inset
  }

  /* Main */
  .main{padding:18px 18px 22px; overflow:auto}
  .grid{
    display:grid; gap:16px;
    grid-template-columns: repeat(12,1fr);
  }
  .card{
    background:var(--card); border-radius:18px; box-shadow:var(--ring); padding:16px
  }
  .kpi{grid-column: span 3; min-width:220px}
  .kpi h4{margin:2px 0 6px; color:#b8c1ea; font-size:12px; letter-spacing:.12em; text-transform:uppercase}
  .kpi .num{font-size:26px; font-weight:800}
  .kpi small{color:var(--muted)}

  .section-title{display:flex; align-items:center; justify-content:space-between; margin:6px 2px 10px}
  .section-title h2{margin:0; font-size:18px}
  .chips{display:flex; gap:8px}
  .chip{
    font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); cursor:pointer;
  }

  /* Project/task cards */
  .proj{grid-column: span 6; display:flex; flex-direction:column; gap:10px}
  .proj h3{margin:0 0 2px; font-size:16px}
  .meta{display:flex; gap:10px; color:var(--muted); font-size:12px}
  .progress{
    height:8px; border-radius:999px; background:rgba(255,255,255,.09); overflow:hidden; position:relative
  }
  .progress > i{
    display:block; height:100%; width:0%;
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    transition:width .45s ease
  }
  .assignees{display:flex; gap:6px; margin-top:6px; flex-wrap:wrap;}
  .pill{
    padding:6px 9px; border-radius:999px; font-size:12px; background:rgba(255,255,255,.08); cursor:pointer;
  }

  /* Right rail */
  .rail{
    padding:16px; border-left:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.15); backdrop-filter: blur(8px);
    overflow:auto
  }
  .notif{display:flex; gap:10px; padding:10px; border-radius:14px; background:var(--card); margin-bottom:10px; cursor:pointer; transition:all .2s ease;}
  .notif:hover{background:var(--card-deep)}
  .notif.unread{border-left:3px solid var(--accent1)}
  .dot{width:10px; height:10px; border-radius:50%}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

  /* Empty state */
  .empty-state{
    grid-column: 1 / -1; text-align:center; padding:3rem 2rem; color:var(--muted);
  }
  .empty-state i{font-size:3rem; margin-bottom:1rem; opacity:.5}
  
  /* Dark scrollbars */
  *{scrollbar-color: rgba(123,44,255,.45) rgba(255,255,255,.06); scrollbar-width: thin;}
  ::-webkit-scrollbar{width:10px; height:10px}
  ::-webkit-scrollbar-track{background:rgba(255,255,255,.06); border-radius:8px}
  ::-webkit-scrollbar-thumb{background:linear-gradient(180deg, var(--accent1), var(--accent2)); border-radius:8px}
  ::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg, #1bbfff, #8a46ff)}
  
  /* Page container helpers */
  .page{max-width:1100px; margin:0 auto;}
  .page .card{margin-bottom:16px;}
  .page-content{min-height:520px;}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  .form-grid .full{grid-column:1 / -1;}
  .form-field{display:flex; flex-direction:column; gap:6px;}
  .form-field input, .form-field select, .form-field textarea{
    background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
    color: var(--text); padding:10px 12px; border-radius:10px; resize:vertical;
  }
  .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px;}
  .calendar-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px;}
  .calendar-cell{min-height:110px;}
  .sticky-header{position:sticky; top:0; background:transparent; z-index:1;}
  
  /* Modal */
  .modal-overlay{
    position:fixed; inset:0;
    background:
      radial-gradient(800px 400px at 50% -10%, rgba(26,32,66,.35), transparent 60%),
      linear-gradient(180deg, rgba(12,16,34,.75), rgba(10,14,29,.75));
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center; z-index:10000; padding:20px;
  }
  .modal{
    width: min(640px, 92vw);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    border: 1px solid rgba(255,255,255,.18);
    border-radius:18px; box-shadow: var(--ring); overflow:hidden;
    color: var(--text);
    color-scheme: dark;
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .modal-body{padding:16px;}
  .modal-actions{display:flex; gap:10px; justify-content:flex-end; padding:0 16px 16px;}
  .close-x{cursor:pointer; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.16); color:var(--text); border-radius:8px; padding:6px 10px;}
  .modal .form-field label{color:var(--muted);}
  .modal input, .modal select, .modal textarea{
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.22);
    color: var(--text);
    caret-color: var(--text);
  }
  .modal input:focus, .modal select:focus, .modal textarea:focus{
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(6,215,255,.12);
  }
  .modal select option, .modal select optgroup{ background-color:#0a0e1d; color: var(--text); }
  .modal input::placeholder, .modal textarea::placeholder{ color: var(--muted); opacity:.9; }

  /* Responsive */
  @media (max-width:1200px){
    .app{grid-template-columns: 220px 1fr 0; grid-template-rows: 72px 1fr}
    .rail{display:none}
    .proj{grid-column: span 12}
    .kpi{grid-column: span 6}
  }
  @media (max-width:820px){
    .side{display:none}
    .app{grid-template-columns:1fr}
    .kpi{grid-column: span 12}
  }
</style>
</head>
<body>
<div class="dots"></div>

<div class="app">

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">TG</div>
      <h1>TaskGrid</h1>
      <span id="roleBadge" class="role-badge">Role: ‚Ä¶</span>
      <span id="topUserName" style="margin-left:10px; font-weight:600; opacity:.9;"></span>
    </div>
    <div class="top-actions">
      <!-- role switcher for demo -->
      <select id="roleSwitch" class="select" title="Switch role">
        <option value="Member">Member</option>
        <option value="Manager">Manager</option>
        <option value="Admin">Admin</option>
      </select>
      <button class="btn-ghost" id="searchBtn">Search</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="side">
    <nav id="menu" class="menu"></nav>
  </aside>

  <!-- Main content -->
  <main class="main">
    <div class="grid" id="content">
      <!-- KPI Row -->
      <div class="card kpi">
        <h4>Projects</h4>
        <div class="num" id="kpiProjects">0</div>
        <small>active projects</small>
      </div>
      <div class="card kpi">
        <h4>Open Tasks</h4>
        <div class="num" id="kpiTasks">0</div>
        <small>pending items</small>
      </div>
      <div class="card kpi">
        <h4>On Track</h4>
        <div class="num" id="kpiOnTrack">0%</div>
        <small>project health</small>
      </div>
      <div class="card kpi">
        <h4>Notifications</h4>
        <div class="num" id="kpiNotifs">0</div>
        <small>unread items</small>
      </div>

      <!-- Section header -->
      <div class="section-title" style="grid-column:1 / -1;">
        <h2 id="sectionTitle">Your Projects</h2>
        <div class="chips">
          <span class="chip" onclick="showCreateTaskForm()">+ Add Task</span>
          <span class="chip" onclick="showTimeline()">Timeline</span>
          <span class="chip" onclick="generateReport()">Reports</span>
        </div>
      </div>

      <!-- Project/Task cards container (filled by JS) -->
      <div id="cardsMount" class="grid" style="grid-column:1 / -1;"></div>
    </div>
  </main>

  <!-- Right rail -->
  <aside class="rail">
    <div class="card" style="margin-bottom:12px;">
      <div class="section-title">
        <h2>Recent Updates</h2>
        <span class="chip">Live</span>
      </div>
      <div id="updates"></div>
    </div>

    <div class="card">
      <div class="section-title">
        <h2>Notifications</h2>
        <span class="chip" id="notifFilter" onclick="toggleNotificationFilter()">All</span>
      </div>
      <div id="notifs"></div>
    </div>
  </aside>
</div>
<script>
/* ------- API Configuration ------- */
// ‚úÖ Always use backend root, even when inside /dashboard
const API_BASE_URL = `${window.location.origin}`;
let authToken = localStorage.getItem('taskgrid_token');

// API Helper Functions
// ‚úÖ Robust API helper ‚Äî handles invalid JSON & wrong paths silently
async function apiCall(path, options = {}) {
  const token = localStorage.getItem("taskgrid_token");
  const headers = {
    "Content-Type": "application/json",
    ...(options.headers || {}),
  };
  if (token) headers.Authorization = `Bearer ${token}`;

  // Normalize path to absolute URL
  const url = path.startsWith("http")
    ? path
    : `${window.location.origin}${path.startsWith("/") ? path : "/" + path}`;

  try {
    const res = await fetch(url, { ...options, headers });
    const text = await res.text();

    // If Flask returned an HTML page instead of JSON, ignore it silently
    if (text.trim().startsWith("<!DOCTYPE") || text.trim().startsWith("<html")) {
      console.warn(`‚ö†Ô∏è HTML response instead of JSON for ${path}`);
      return {};
    }

    if (!res.ok) {
      console.warn("‚ö†Ô∏è API call failed:", path, res.status);
      return {};
    }

    try {
      return JSON.parse(text);
    } catch (err) {
      console.warn(`‚ö†Ô∏è Non-JSON response for ${path}:`, text.slice(0, 60));
      return {};
    }
  } catch (err) {
    console.error(`‚ùå Network error for ${path}:`, err);
    return {};
  }
}


/* ------- User Data Management ------- */
let sample = {
  projects: [],
  tasksMine: [],
  members: [],
  updates: [],
  notifs: [],
  profile: {
    name: "User",
    email: "user@taskgrid.com",
    role: "Member",
    joinDate: new Date().toISOString().split('T')[0],
    avatar: "YU",
    preferences: {
      notifications: true,
      emailAlerts: true,
      theme: "dark"
    }
  }
};
// ‚úÖ Function to fetch profile and update UI immediately
async function loadUserProfile() {
  try {
    const prof = await apiCall('/auth/profile');
    if (prof && prof.user) {
      localStorage.setItem('taskgrid_user', JSON.stringify(prof.user));
      updateProfileUI(prof.user);
    } else {
      console.warn('‚ö†Ô∏è Could not fetch profile:', prof);
    }
  } catch (err) {
    console.error('‚ùå Profile fetch error:', err);
  }
}

// ‚úÖ Function to fill UI fields dynamically
function updateProfileUI(user) {
  const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'User';
  const email = user.email || '';
  const role = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'Member';

  const nameEl = document.getElementById('profile-name');
  const emailEl = document.getElementById('profile-email');
  const roleEl = document.getElementById('profile-role');
  const topUserEl = document.getElementById('topUserName');

  if (nameEl) nameEl.textContent = fullName;
  if (emailEl) emailEl.textContent = email;
  if (roleEl) roleEl.textContent = role;
  if (topUserEl) topUserEl.textContent = user.first_name || user.username || 'User';
}

// Load data from backend
// ‚úÖ Improved version ‚Äî loads data instantly and handles partial failures safely
async function loadUserData() {
  if (!authToken) {
    console.warn("‚ö†Ô∏è No token found. Redirecting to login.");
    window.location.href = "/";
    return;
  }
   
  try {
    // --- Step 1: Load profile (from local or backend) ---
    let user = null;
    const stored = localStorage.getItem("taskgrid_user");
    if (stored) {
      try { user = JSON.parse(stored); } catch {}
    }

    if (!user) {
      const prof = await apiCall("/auth/profile");
      if (prof && prof.user) {
        user = prof.user;
        localStorage.setItem("taskgrid_user", JSON.stringify(user));
      }
    }

    if (user) setProfileFromUser(user);

    // --- Step 2: Load tasks first (critical path) ---
    // --- Step 2: Load tasks first (critical path) ---
const tasksData = await apiCall("/data/tasks");
const rawTasks = tasksData.tasks || [];

// üîÑ Normalize server task objects to match UI expectations
sample.tasksMine = rawTasks.map(t => {
  const rawId = t._id || t.id;
  const idStr = rawId != null ? String(rawId) : String(Date.now() + Math.random());
  return {
  id: idStr,
  _id: idStr,
  title: t.title || "Untitled Task",
  description: t.description || "",
  status: (t.status || "todo").toLowerCase(),
  priority: (t.priority || "medium").toLowerCase(),
  progress: Number(t.progress || 0),
  // Normalize dates
  start_date: t.start_date || t.startDate || null,
  due_date: t.due_date || t.dueDate || null,
  due: t.due_date || t.dueDate || t.due || null,
  // Project association
  project_id: t.project_id || t.projectId || t.project_id_str || null,
  project: t.project_name || t.project || "Unknown Project",
  // Assignee
  assignee: t.assignee || t.assignee_name || "You",
  assignee_name: t.assignee_name || t.assignee || "You",
  // Misc
  estimated_hours: Number(t.estimated_hours || 0),
  created: t.created_at || new Date().toISOString()
}));

console.log("‚úÖ Normalized tasks:", sample.tasksMine);

// --- Step 3: Render tasks immediately ---
renderMain();
fillKPIs();


    // --- Step 3: Render tasks immediately ---
    renderMain();
    fillKPIs();

    // --- Step 4: Load projects (secondary) ---
    try {
      const projectsData = await apiCall("/data/projects");
      sample.projects = projectsData.projects || [];
      console.log("‚úÖ Loaded projects:", sample.projects);
    } catch (err) {
      console.warn("‚ö†Ô∏è Could not load projects:", err);
    }

    // --- Step 5: Load members list (optional) ---
    try {
      const usersData = await apiCall("/data/users");
      sample.members = usersData.users || [];
    } catch {
      sample.members = [];
    }

    // --- Step 6: Updates, notifs, role, etc. ---
    sample.updates = [{ t: "Dashboard synced!", kind: "ok", time: "Now" }];
    sample.notifs = sample.notifs || [];
    updateRoleUI();
    renderRightRail();
    fillKPIs();

  } catch (error) {
    console.error("‚ùå Failed to load data:", error);
    setTimeout(loadUserData, 3000); // retry silently
  }
}


function saveUserData(data) {
  // Save to localStorage as backup
  const userId = localStorage.getItem('taskgrid_user_id');
  if (userId) {
    localStorage.setItem(`taskgrid_data_${userId}`, JSON.stringify(data));
  }
  
  // Data is automatically saved to backend through API calls
  console.log('Data saved locally as backup');
}

// Map backend role to UI label
function uiRoleFromBackend(role){
  if (!role) return 'Member';
  const map = { admin:'Admin', manager:'Manager', team_member:'Member', member:'Member' };
  const key = String(role).toLowerCase();
  return map[key] || (key.charAt(0).toUpperCase()+key.slice(1));
}

// Populate sample.profile from backend/local user object
function setProfileFromUser(u){
  if (!u) return;
  const first = (u.first_name||u.firstName||'').trim();
  const last = (u.last_name||u.lastName||'').trim();
  const name = [first,last].filter(Boolean).join(' ') || u.username || u.email || 'User';
  const email = u.email || '';
  const roleLabel = uiRoleFromBackend(u.role||u.user_role);
  const joined = u.created_at || new Date().toISOString();
  const baseForInitials = (first ? `${first} ${last}` : (name||''));
  const initials = baseForInitials.split(' ').filter(Boolean).map(s=>s[0]).join('').toUpperCase().slice(0,2) || 'U';
  sample.profile = {
    name,
    email,
    role: roleLabel,
    joinDate: joined,
    avatar: initials,
    preferences: sample.profile?.preferences || { notifications:true, emailAlerts:true, theme:'dark' }
  };
}

/* ------- Utility functions ------- */
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 10000;
    background: ${type === 'success' ? '#2ad39a' : type === 'error' ? '#ff5d6c' : type === 'warn' ? '#ffb020' : '#06d7ff'};
    color: white; padding: 12px 20px; border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(100%);
    transition: transform 0.3s ease; max-width: 400px;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.style.transform = 'translateX(0)', 100);
  setTimeout(() => {
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

function formatDate(dateString) {
  if (!dateString) return 'No date';
  const date = new Date(dateString);
  const today = new Date();
  const diffTime = date - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Tomorrow';
  if (diffDays === -1) return 'Yesterday';
  if (diffDays < 0) return `${Math.abs(diffDays)} days overdue`;
  if (diffDays <= 7) return `${diffDays} days`;
  
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function getDaysUntilDeadline(dueDate) {
  if (!dueDate) return null;
  const today = new Date();
  const deadline = new Date(dueDate);
  const diffTime = deadline - today;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

function getTaskStatus(task) {
  const daysUntil = getDaysUntilDeadline(task.due);
  if (task.status === 'completed') return 'completed';
  if (daysUntil < 0) return 'overdue';
  if (daysUntil <= 2) return 'due-soon';
  return 'normal';
}

/* ------- Role & shell wiring ------- */
const roleSwitch = document.getElementById('roleSwitch');
const roleBadge  = document.getElementById('roleBadge');
const menuMount  = document.getElementById('menu');
const cardsMount = document.getElementById('cardsMount');
const sectionTitle = document.getElementById('sectionTitle');

function detectRole(){
  try {
    const stored = localStorage.getItem('taskgrid_user');
    if (stored) {
      const u = JSON.parse(stored);
      const r = uiRoleFromBackend(u.role || u.user_role);
      if (roleSwitch) roleSwitch.value = r;
      return r;
    }
  } catch (e) {}
  const r = sample.profile?.role || 'Member';
  if (roleSwitch) roleSwitch.value = r;
  return r;
}


roleSwitch.addEventListener('change', ()=>{
  role = roleSwitch.value;
  roleBadge.textContent = `Role: ${role}`;
  renderMenu();
  renderMain();
});
 /* ------- RENDER MAIN FUNCTION ------- */
/* ------- RENDER MAIN FUNCTION ------- */
function renderMain() {
  const mount = document.getElementById('cardsMount');
  mount.innerHTML = '';

  // üü£ Show loading spinner while tasks load
  mount.innerHTML = `<div class="empty-state"><i>‚è≥</i><p>Loading tasks...</p></div>`;

  // Wait a short delay (for smoother transitions)
  setTimeout(() => {
    mount.innerHTML = '';

    // üî∏ Case 1: No tasks found
    if (!sample.tasksMine || sample.tasksMine.length === 0) {
      mount.innerHTML = `
        <div class="empty-state">
          <i>üóíÔ∏è</i>
          <h3>No tasks yet</h3>
          <p>Click <b>+ Add Task</b> above to create your first task.</p>
        </div>`;
      // Append quick actions even if no tasks
      mount.appendChild(AdminPanel());
      return;
    }

    // üîπ Case 2: Tasks found
    sample.tasksMine.forEach(t => {
      const card = TaskCard(t);
      mount.appendChild(card);
    });

    // ‚úÖ Add Quick Actions at bottom
    mount.appendChild(AdminPanel());

  }, 300);
}

let role = detectRole();
updateRoleUI();

function updateRoleUI(){
  roleBadge.textContent = `Role: ${role}`;
  renderMenu();
  renderRightRail();
  renderMain();
  fillKPIs();
}

function renderMenu(){
  const groups = {
    Admin: [
      ["Projects","/projects"],
      ["Tasks","/tasks"],
      ["Users","/users"],
      ["Profile","/profile"]
    ],
    Manager: [
      ["Projects","/projects"],
      ["Tasks","/tasks"],
      ["Notifications","/notifications"],
      ["Profile","/profile"]
    ],
    Member: [
      ["Tasks","/tasks"],
      ["Projects","/projects"],
      ["Notifications","/notifications"],
      ["Profile","/profile"]
    ]
  };
  const list = groups[role] || groups.Member;
  menuMount.innerHTML = `<h3>Menu</h3>` + list.map(([label]) =>
    `<div class="item${label==='Projects'?' active':''}" onclick="navigateToSection('${label}')">${label}</div>`
  ).join('');
}

/* ------- Navigation Functions ------- */
function navigateToSection(section) {
  // Remove active class from all items
  document.querySelectorAll('.item').forEach(item => item.classList.remove('active'));
  // Add active class to clicked item
  event.target.classList.add('active');
  
  if (section === 'Profile') {
    showProfile();
  } else if (section === 'Notifications') {
    showNotifications();
  } else if (section === 'Tasks') {
    sectionTitle.textContent = "Your Tasks";
    renderMain();
  } else if (section === 'Projects') {
    sectionTitle.textContent = "Your Projects";
    renderMain();
  } else if (section === 'Reports') {
    // Navigate to the new Report Analysis page
    window.location.href = '../reports/analysis.html';
  } else if (section === 'Report Analysis') {
    showReportAnalysis();
  } else {
    showToast(`${section} section - Coming soon!`, 'info');
  }
}

/* ------- Profile Management ------- */
function showProfile() {
  sectionTitle.textContent = "Profile Settings";

  // ‚úÖ Always use the latest user info from localStorage or backend
  let user = null;
  try {
    user = JSON.parse(localStorage.getItem('taskgrid_user'));
  } catch (e) {}

  if (!user || !user.email) {
    // fallback: use default
    user = sample.profile;
  }

  const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'User';
  const email = user.email || 'Not available';
  const role = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'Member';
  const joinDate = user.created_at ? formatDate(user.created_at) : formatDate(sample.profile.joinDate);
  const initials = (user.first_name?.[0] || user.username?.[0] || 'U').toUpperCase();

  cardsMount.innerHTML = `
    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>Profile Information</h2>
        <span class="chip" onclick="editProfile()">Edit</span>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: start;">
        <div style="text-align: center;">
          <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--accent1), var(--accent2)); display: grid; place-items: center; font-size: 24px; font-weight: 800; margin: 0 auto 10px;">
            ${initials}
          </div>
          <h3 id="profile-name">${fullName}</h3>
          <p id="profile-role" style="color: var(--muted);">${role}</p>
        </div>
        <div>
          <div style="margin-bottom: 15px;">
            <strong>Email:</strong> <span id="profile-email">${email}</span>
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Role:</strong> ${role}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Joined:</strong> ${joinDate}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Tasks Created:</strong> ${sample.tasksMine.length}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Projects:</strong> ${sample.projects.length}
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>Preferences</h2>
      </div>
      <div style="display: grid; gap: 15px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" ${sample.profile.preferences.notifications ? 'checked' : ''} onchange="togglePreference('notifications')">
          <span>Email Notifications</span>
        </label>
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" ${sample.profile.preferences.emailAlerts ? 'checked' : ''} onchange="togglePreference('emailAlerts')">
          <span>Deadline Alerts</span>
        </label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span>Theme:</span>
          <select onchange="changeTheme(this.value)" style="background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,.1); padding: 5px; border-radius: 5px;">
            <option value="dark" ${sample.profile.preferences.theme === 'dark' ? 'selected' : ''}>Dark</option>
            <option value="light" ${sample.profile.preferences.theme === 'light' ? 'selected' : ''}>Light</option>
          </select>
        </div>
      </div>
    </div>
  `;
}

function editProfile() {
  const newName = prompt('Enter your name:', sample.profile.name);
  const newEmail = prompt('Enter your email:', sample.profile.email);
  
  if (newName && newEmail) {
    sample.profile.name = newName;
    sample.profile.email = newEmail;
    sample.profile.avatar = newName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    saveUserData(sample);
    showProfile();
    showToast('Profile updated successfully!', 'success');
  }
}

function togglePreference(pref) {
  sample.profile.preferences[pref] = !sample.profile.preferences[pref];
  saveUserData(sample);
  showToast(`${pref} ${sample.profile.preferences[pref] ? 'enabled' : 'disabled'}`, 'success');
}

function changeTheme(theme) {
  sample.profile.preferences.theme = theme;
  saveUserData(sample);
  showToast(`Theme changed to ${theme}`, 'success');
}

/* ------- Notifications Management ------- */
if (typeof showUnreadOnly === 'undefined') {
    var showUnreadOnly = false;
}


function showNotifications() {
  sectionTitle.textContent = "Notifications Center";
  const unreadCount = sample.notifs.filter(n => !n.read).length;
  
  cardsMount.innerHTML = `
    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>All Notifications (${sample.notifs.length})</h2>
        <div style="display: flex; gap: 8px;">
          <span class="chip" onclick="markAllAsRead()">Mark All Read</span>
          <span class="chip" onclick="clearAllNotifications()">Clear All</span>
        </div>
      </div>
      <div style="margin-bottom: 15px;">
        <span style="color: var(--muted);">Unread: ${unreadCount}</span>
      </div>
      <div id="notificationsList">
        ${sample.notifs.map(n => `
          <div class="notif ${!n.read ? 'unread' : ''}" onclick="markAsRead(${n.id || Date.now()})">
            <span class="dot ${n.kind}"></span>
            <div style="flex: 1;">
              <div>${n.t}</div>
              <small style="color: var(--muted); font-size: 10px;">${n.time}</small>
            </div>
            ${!n.read ? '<div style="width: 8px; height: 8px; background: var(--accent1); border-radius: 50%;"></div>' : ''}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function toggleNotificationFilter() {
  showUnreadOnly = !showUnreadOnly;
  document.getElementById('notifFilter').textContent = showUnreadOnly ? 'Unread' : 'All';
  updateNotifications();
}

function markAsRead(notifId) {
  const notif = sample.notifs.find(n => n.id === notifId);
  if (notif) {
    notif.read = true;
    saveUserData(sample);
    showToast('Notification marked as read', 'success');
    if (document.getElementById('notificationsList')) {
      showNotifications(); // Refresh if in notifications view
    }
    updateNotifications(); // Update sidebar
  }
}

function markAllAsRead() {
  sample.notifs.forEach(n => n.read = true);
  saveUserData(sample);
  showToast('All notifications marked as read', 'success');
  if (document.getElementById('notificationsList')) {
    showNotifications();
  }
  updateNotifications();
}

function clearAllNotifications() {
  if (confirm('Are you sure you want to clear all notifications?')) {
    sample.notifs = [];
    saveUserData(sample);
    showToast('All notifications cleared', 'success');
    if (document.getElementById('notificationsList')) {
      showNotifications();
    }
    updateNotifications();
  }
}

/* ------- Enhanced Project Card with deadline features ------- */
function ProjectCard(p){
  const el = document.createElement('div');
  el.className = 'card proj';
  
  const daysUntil = getDaysUntilDeadline(p.deadline);
  let deadlineStatus = '';
  let deadlineColor = 'var(--muted)';
  
  if (p.deadline) {
    if (daysUntil < 0) {
      deadlineStatus = `${Math.abs(daysUntil)} days overdue`;
      deadlineColor = 'var(--bad)';
    } else if (daysUntil <= 7) {
      deadlineStatus = `Due in ${daysUntil} days`;
      deadlineColor = daysUntil <= 2 ? 'var(--warn)' : 'var(--ok)';
    } else {
      deadlineStatus = `Due ${formatDate(p.deadline)}`;
    }
  } else {
    deadlineStatus = 'No deadline set';
  }
  
  // Calculate progress from backend data or default to 0
  const progress = p.get_progress ? p.get_progress() : (p.progress || 0);
  const taskCount = p.task_count || p.openTasks || 0;
  const ownerName = p.owner_name || p.owner || 'Unknown';
  
  el.innerHTML = `
    <h3>${p.name}</h3>
    <div class="meta">
      <span>Owner: ${ownerName}</span> ‚Ä¢ 
      <span>${taskCount} tasks</span> ‚Ä¢ 
      <span style="color: ${deadlineColor}">${deadlineStatus}</span>
    </div>
    <div class="progress"><i style="width:${progress}%"></i></div>
    <div class="assignees">
      <span class="pill">${p.status === 'active' ? 'Active' : p.status}</span>
      <span class="pill">Progress ${progress}%</span>
      <span class="pill" onclick="showProjectTimeline(${p.id})">üìÖ Timeline</span>
    </div>
  `;
  el.style.gridColumn = 'span 6';
  return el;
}

/* ------- Enhanced Task Card with deadline features ------- */
{
function TaskCard(t){
  const el = document.createElement('div');
  el.className = 'card proj';
  
  // Handle both due_date (backend) and due (frontend) properties
  const dueDate = t.due_date || t.due;
  const taskStatus = getTaskStatus({...t, due: dueDate});
  const daysUntil = getDaysUntilDeadline(dueDate);
  
  let statusColor = 'var(--muted)';
  let statusText = formatDate(dueDate);
  
  if (taskStatus === 'overdue') {
    statusColor = 'var(--bad)';
    statusText = `${Math.abs(daysUntil)} days overdue`;
  } else if (taskStatus === 'due-soon') {
    statusColor = 'var(--warn)';
    statusText = `Due in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`;
  } else if (taskStatus === 'completed') {
    statusColor = 'var(--ok)';
    statusText = 'Completed';
  }
  
  // Calculate progress (backend tasks might not have progress field)
  const progress = t.progress || 0;
  const projectName = t.project_name || t.project || 'Unknown Project';
  const assigneeName = t.assignee_name || t.assignee || 'Unassigned';

  // Ensure id is always passed as a safe JS string (escape single quotes)
  const rawId = t._id || t.id || '';
  const safeId = String(rawId).replace(/'/g, "\\'");

  el.innerHTML = `
    <h3>${escapeHtml(t.title)}</h3>
    <div class="meta">
      <span>${escapeHtml(projectName)}</span> ‚Ä¢ 
      <span style="color: ${statusColor}">${statusText}</span> ‚Ä¢ 
      <span>Priority: ${escapeHtml(t.priority)}</span>
    </div>
    <div class="progress"><i style="width:${progress}%"></i></div>
    <div class="assignees">
      <span class="pill">${escapeHtml(assigneeName)}</span>
      <span class="pill editable-progress" onclick="editTaskProgress('${safeId}', ${progress})">Progress ${progress}%</span>
      <span class="pill" onclick="updateTaskProgress('${safeId}')">üìà Update</span>
      <span class="pill" onclick="assignTask('${safeId}')">üë• Assign</span>
      <span class="pill" style="background: rgba(255,93,108,.2);" onclick="deleteTask('${safeId}')">üóë Delete</span>
    </div>
  `;
  el.style.gridColumn = 'span 6';
  return el;
}
}
/* ------- Admin Panel: Quick Actions ------- */
function AdminPanel() {
  const el = document.createElement('div');
  el.className = 'card';
  el.style.gridColumn = '1 / -1';
  el.innerHTML = `
    <div class="section-title" style="margin-bottom:8px;">
      <h2>Quick Actions</h2>
      <span class="chip">Enhanced</span>
    </div>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <button class="btn-ghost" onclick="showCreateTaskForm()">‚ûï Add Task</button>
      <button class="btn-ghost" onclick="showMembers()">üë• View Members</button>
      <button class="btn-ghost" onclick="generateReport()">üìä Generate Report</button>
      <button class="btn-ghost" onclick="showDeadlines()">üìÖ View Deadlines</button>
      <button class="btn-ghost" onclick="exportData()">üíæ Export Data</button>
      <button class="btn-ghost" onclick="showProfile()">üë§ Profile</button>
    </div>
  `;
  return el;
}

// ‚úÖ Replace your current editTaskProgress() function with this one
async function editTaskProgress(taskId) {
  // Normalize id
  const idStr = String(taskId);
  const task = sample.tasksMine.find(t => String(t.id) === idStr || String(t._id) === idStr);
  if (!task) {
    showToast('Task not found.', 'error');
    return;
  }

  // Build modal (re-uses modal styles already present)
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'updateTaskOverlay';
  overlay.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="updateTaskTitle" style="max-width:720px;">
      <div class="modal-header">
        <h2 id="updateTaskTitle" style="margin:0;font-size:18px;">Update Task ‚Äî ${escapeHtml(task.title || 'Untitled')}</h2>
        <button class="close-x" id="updateTaskCloseBtn">Close</button>
      </div>
      <div class="modal-body">
        <form id="updateTaskForm" class="form-grid">
          <div class="form-field full">
            <label>Title *</label>
            <input type="text" name="title" required value="${escapeHtml(task.title||'')}" />
          </div>
          <div class="form-field full">
            <label>Description</label>
            <textarea name="description" rows="4">${escapeHtml(task.description||'')}</textarea>
          </div>
          <div class="form-field">
            <label>Priority</label>
            <select name="priority">
              <option value="low" ${task.priority==='low'?'selected':''}>Low</option>
              <option value="medium" ${task.priority==='medium'?'selected':''}>Medium</option>
              <option value="high" ${task.priority==='high'?'selected':''}>High</option>
              <option value="urgent" ${task.priority==='urgent'?'selected':''}>Urgent</option>
            </select>
          </div>
          <div class="form-field">
            <label>Progress (%)</label>
            <input type="number" name="progress" min="0" max="100" value="${Number(task.progress||0)}" />
          </div>
          <div class="form-field">
            <label>Start Date</label>
            <input type="date" name="start_date" value="${task.start_date ? (new Date(task.start_date)).toISOString().split('T')[0] : ''}" />
          </div>
          <div class="form-field">
            <label>Due Date</label>
            <input type="date" name="due_date" value="${task.due_date ? (new Date(task.due_date)).toISOString().split('T')[0] : (task.due ? (new Date(task.due)).toISOString().split('T')[0] : '')}" />
          </div>
          <div class="form-field">
            <label>Estimated Hours</label>
            <input type="number" name="estimated_hours" min="0" step="0.5" value="${Number(task.estimated_hours||0)}" />
          </div>
          <div class="form-field">
            <label>Assignee</label>
            <input type="text" name="assignee" value="${escapeHtml(task.assignee_name||task.assignee||'You')}" />
          </div>
          <div class="modal-actions full">
            <button type="button" class="btn-ghost" id="updateTaskCancelBtn">Cancel</button>
            <button type="submit" class="btn">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  `;

  // Append and wire events
  document.body.appendChild(overlay);
  document.body.style.overflow = 'hidden';

  overlay.querySelector('#updateTaskCloseBtn').onclick = closeUpdateTaskModal;
  overlay.querySelector('#updateTaskCancelBtn').onclick = closeUpdateTaskModal;
  overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeUpdateTaskModal(); });

  const form = overlay.querySelector('#updateTaskForm');
  form.addEventListener('submit', async function submitHandler(e){
    e.preventDefault();
    await submitUpdateTaskForm(e, task);
  });

  // ESC handler
  window._tgUpdateEsc = (ev) => { if (ev.key === 'Escape') closeUpdateTaskModal(); };
  document.addEventListener('keydown', window._tgUpdateEsc);
}

// Close modal and cleanup
function closeUpdateTaskModal(){
  const overlay = document.getElementById('updateTaskOverlay');
  if (overlay) overlay.remove();
  document.body.style.overflow = '';
  if (window._tgUpdateEsc) {
    document.removeEventListener('keydown', window._tgUpdateEsc);
    window._tgUpdateEsc = null;
  }
}

// Form submit: validate, update local and backend
async function submitUpdateTaskForm(event, originalTask) {
  const form = event.target;
  const data = Object.fromEntries(new FormData(form).entries());

  const title = (data.title || '').trim();
  const progress = Number(data.progress || 0);
  const start_date = data.start_date || null;
  const due_date = data.due_date || null;
  const estimated_hours = parseFloat(data.estimated_hours || '0') || 0;
  const assignee = (data.assignee || '').trim();
  const priority = (data.priority || 'medium').toLowerCase();

  // Basic validation
  if (!title) { showToast('Title is required', 'error'); return; }
  if (isNaN(progress) || progress < 0 || progress > 100) { showToast('Progress must be 0‚Äì100', 'error'); return; }
  if (start_date && !isValidDate(start_date)) { showToast('Invalid start date', 'error'); return; }
  if (due_date && !isValidDate(due_date)) { showToast('Invalid due date', 'error'); return; }
  if (start_date && due_date && new Date(due_date) <= new Date(start_date)) { showToast('Due date must be after start date', 'error'); return; }

  // Update local object
  const task = sample.tasksMine.find(t => String(t.id) === String(originalTask.id) || String(t._id) === String(originalTask._id));
  if (!task) { showToast('Task not found locally', 'error'); closeUpdateTaskModal(); return; }

  task.title = title;
  task.description = data.description || '';
  task.priority = priority;
  task.progress = progress;
  task.start_date = start_date || task.start_date;
  task.due_date = due_date || task.due_date || task.due;
  task.due = task.due_date;
  task.estimated_hours = estimated_hours;
  task.assignee = assignee;
  task.assignee_name = assignee;
  if (progress >= 100) task.status = 'completed';

  saveUserData(sample);
  renderMain();
  updateNotifications();
  fillKPIs();
  showToast('Task updated locally', 'success');

  // Try to sync with backend
  try {
    const apiId = task._id || task.id;
    const payload = {
      title: task.title,
      description: task.description,
      priority: task.priority,
      progress: task.progress,
      start_date: task.start_date,
      due_date: task.due_date,
      estimated_hours: task.estimated_hours,
      assignee: task.assignee,
      status: task.status
    };
    const res = await apiCall(`/data/tasks/${apiId}`, {
      method: 'PATCH',
      body: JSON.stringify(payload)
    });

    if (res && !res.error) {
      showToast('Task synced with server', 'success');
    } else {
      console.warn('Server sync failed:', res);
      showToast('Saved locally (server sync failed)', 'warn');
    }
  } catch (err) {
    console.error('Sync error:', err);
    showToast('Saved locally (offline)', 'warn');
  } finally {
    closeUpdateTaskModal();
  }
}

// small helper to escape simple HTML in inserted strings
function escapeHtml(str){
  if (!str) return '';
  return String(str).replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}

/* ------- Initialize ------- */
document.addEventListener('DOMContentLoaded', async function() {
  // Load user data from backend
  await loadUserData();
  await loadUserProfile();
  
  // Add enhanced search functionality
  document.getElementById('searchBtn').onclick = performSearch;
  
  // Update notifications on load
  setTimeout(updateNotifications, 1000);
  
  // Auto-refresh notifications every minute
  setInterval(updateNotifications, 60000);
  
  // Auto-save data every 30 seconds
  setInterval(() => saveUserData(sample), 30000);
  
  // Auto-refresh data from server every 5 minutes
  setInterval(async () => {
    try {
      await loadUserData();
      console.log('Data refreshed from server');
    } catch (error) {
      console.log('Failed to refresh data from server');
    }
  }, 300000); // 5 minutes
  
  console.log('‚úÖ TaskGrid Dashboard loaded with backend integration!');
  console.log('‚úÖ Enhanced search functionality implemented!');
  console.log('‚úÖ All tasks require start date and due date!');
  console.log('‚úÖ Data automatically syncs with server!');
});

// Add missing wrapper so Update button opens the modal editor
function updateTaskProgress(taskId) {
  const idStr = String(taskId);
  const task = sample.tasksMine.find(t => String(t.id) === idStr || String(t._id) === idStr);
  if (!task) {
    showToast('Task not found.', 'error');
    return;
  }
  // Forward to the existing modal editor
  return editTaskProgress(idStr);
}

</script>
</body>
</html>