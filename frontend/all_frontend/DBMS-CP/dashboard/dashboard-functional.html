<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TaskGrid ‚Äî Dashboard</title>
<style>
  :root{
    --bg:#0c1022;
    --bg2:#0a0e1d;
    --card:rgba(255,255,255,.06);
    --card-deep:rgba(255,255,255,.08);
    --muted:#a6b0d1;
    --text:#e9ecff;
    --accent1:#06d7ff;
    --accent2:#7b2cff;
    --ok:#2ad39a;
    --warn:#ffb020;
    --bad:#ff5d6c;
    --ring: 0 0 0 1px rgba(255,255,255,.06) inset, 0 10px 30px rgba(0,0,0,.45);
  }

  /* Page */
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    color:var(--text);
    font:15px/1.45 "Segoe UI",Inter,system-ui,-apple-system,Arial,sans-serif;
    background:
      radial-gradient(1200px 600px at 70% -10%, #1a2042 0%, transparent 60%),
      radial-gradient(900px 500px at -10% 20%, #12183a 0%, transparent 55%),
      linear-gradient(180deg, var(--bg) 0%, var(--bg2) 100%);
    overflow:hidden;
  }

  /* Subtle starfield dots */
  .dots{position:fixed; inset:0; pointer-events:none; opacity:.35}
  .dots::before,.dots::after{
    content:""; position:absolute; inset:-20%;
    background-image:
      radial-gradient(#8ad 1px, transparent 1px),
      radial-gradient(#6cf 1px, transparent 1px),
      radial-gradient(#9bf 1px, transparent 1px);
    background-size: 120px 120px, 180px 180px, 240px 240px;
    background-position: 0 0, 40px 60px, 100px 20px;
    filter: blur(.2px);
    animation: drift 60s linear infinite;
  }
  .dots::after{animation-duration:85s; opacity:.8}
  @keyframes drift{to{transform:translateY(80px)}}

  /* App shell */
  .app{display:grid; grid-template-columns: 260px 1fr 330px; grid-template-rows: 72px 1fr; height:100%}

  .topbar{
    grid-column:1 / -1;
    display:flex; align-items:center; gap:16px;
    padding:12px 18px;
    border-bottom:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; align-items:center; gap:10px; margin-right:auto}
  .logo{
    width:36px; height:36px; border-radius:10px;
    background:linear-gradient(135deg, var(--accent1), var(--accent2));
    display:grid; place-items:center; font-weight:800
  }
  .brand h1{font-size:16px; margin:0; letter-spacing:.4px; opacity:.95}
  .role-badge{
    padding:6px 10px; border-radius:999px;
    background:linear-gradient(90deg, rgba(6,215,255,.15), rgba(123,44,255,.15));
    border:1px solid rgba(123,44,255,.35);
    font-size:12px; letter-spacing:.3px
  }
  .top-actions{display:flex; align-items:center; gap:10px}
  .btn, .btn-ghost{
    padding:10px 14px; border-radius:12px; border:0; cursor:pointer; font-weight:600; color:var(--text)
  }
  .btn{
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    box-shadow:0 8px 24px rgba(123,44,255,.3)
  }
  .btn-ghost{background:rgba(255,255,255,.06)}
  .select{
    appearance:none; background:rgba(255,255,255,.06); border:0; color:var(--text);
    padding:10px 36px 10px 12px; border-radius:12px; font-weight:600; position:relative
  }

  /* Sidebar */
  .side{
    padding:16px; border-right:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.15); backdrop-filter: blur(8px)
  }
  .menu{display:flex; flex-direction:column; gap:8px}
  .menu h3{margin:10px 8px 6px; color:#b8c1ea; font-size:12px; letter-spacing:.15em; text-transform:uppercase}
  .item{
    padding:12px 12px; border-radius:12px; background:transparent; color:var(--text); text-decoration:none; display:flex; align-items:center; gap:10px; cursor:pointer;
  }
  .item.active, .item:hover{
    background:linear-gradient(90deg, rgba(6,215,255,.12), rgba(123,44,255,.12));
    box-shadow:0 1px 0 0 rgba(255,255,255,.04) inset
  }

  /* Main */
  .main{padding:18px 18px 22px; overflow:auto}
  .grid{
    display:grid; gap:16px;
    grid-template-columns: repeat(12,1fr);
  }
  .card{
    background:var(--card); border-radius:18px; box-shadow:var(--ring); padding:16px
  }
  .kpi{grid-column: span 3; min-width:220px}
  .kpi h4{margin:2px 0 6px; color:#b8c1ea; font-size:12px; letter-spacing:.12em; text-transform:uppercase}
  .kpi .num{font-size:26px; font-weight:800}
  .kpi small{color:var(--muted)}

  .section-title{display:flex; align-items:center; justify-content:space-between; margin:6px 2px 10px}
  .section-title h2{margin:0; font-size:18px}
  .chips{display:flex; gap:8px}
  .chip{
    font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); cursor:pointer;
  }

  /* Project/task cards */
  .proj{grid-column: span 6; display:flex; flex-direction:column; gap:10px}
  .proj h3{margin:0 0 2px; font-size:16px}
  .meta{display:flex; gap:10px; color:var(--muted); font-size:12px}
  .progress{
    height:8px; border-radius:999px; background:rgba(255,255,255,.09); overflow:hidden; position:relative
  }
  .progress > i{
    display:block; height:100%; width:0%;
    background:linear-gradient(90deg, var(--accent1), var(--accent2));
    transition:width .45s ease
  }
  .assignees{display:flex; gap:6px; margin-top:6px; flex-wrap:wrap;}
  .pill{
    padding:6px 9px; border-radius:999px; font-size:12px; background:rgba(255,255,255,.08); cursor:pointer;
  }

  /* Right rail */
  .rail{
    padding:16px; border-left:1px solid rgba(255,255,255,.06); background:rgba(0,0,0,.15); backdrop-filter: blur(8px);
    overflow:auto
  }
  .notif{display:flex; gap:10px; padding:10px; border-radius:14px; background:var(--card); margin-bottom:10px; cursor:pointer; transition:all .2s ease;}
  .notif:hover{background:var(--card-deep)}
  .notif.unread{border-left:3px solid var(--accent1)}
  .dot{width:10px; height:10px; border-radius:50%}
  .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}

  /* Empty state */
  .empty-state{
    grid-column: 1 / -1; text-align:center; padding:3rem 2rem; color:var(--muted);
  }
  .empty-state i{font-size:3rem; margin-bottom:1rem; opacity:.5}
  
  /* Dark scrollbars */
  *{scrollbar-color: rgba(123,44,255,.45) rgba(255,255,255,.06); scrollbar-width: thin;}
  ::-webkit-scrollbar{width:10px; height:10px}
  ::-webkit-scrollbar-track{background:rgba(255,255,255,.06); border-radius:8px}
  ::-webkit-scrollbar-thumb{background:linear-gradient(180deg, var(--accent1), var(--accent2)); border-radius:8px}
  ::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg, #1bbfff, #8a46ff)}
  
  /* Page container helpers */
  .page{max-width:1100px; margin:0 auto;}
  .page .card{margin-bottom:16px;}
  .page-content{min-height:520px;}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  .form-grid .full{grid-column:1 / -1;}
  .form-field{display:flex; flex-direction:column; gap:6px;}
  .form-field input, .form-field select, .form-field textarea{
    background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
    color: var(--text); padding:10px 12px; border-radius:10px; resize:vertical;
  }
  .actions{display:flex; gap:10px; justify-content:flex-end; margin-top:10px;}
  .calendar-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px;}
  .calendar-cell{min-height:110px;}
  .sticky-header{position:sticky; top:0; background:transparent; z-index:1;}
  
  /* Modal */
  .modal-overlay{
    position:fixed; inset:0;
    background:
      radial-gradient(800px 400px at 50% -10%, rgba(26,32,66,.35), transparent 60%),
      linear-gradient(180deg, rgba(12,16,34,.75), rgba(10,14,29,.75));
    backdrop-filter: blur(6px);
    display:flex; align-items:center; justify-content:center; z-index:10000; padding:20px;
  }
  .modal{
    width: min(640px, 92vw);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
    border: 1px solid rgba(255,255,255,.18);
    border-radius:18px; box-shadow: var(--ring); overflow:hidden;
    color: var(--text);
    color-scheme: dark;
  }
  .modal-header{
    display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .modal-body{padding:16px;}
  .modal-actions{display:flex; gap:10px; justify-content:flex-end; padding:0 16px 16px;}
  .close-x{cursor:pointer; background:rgba(255,255,255,.1); border:1px solid rgba(255,255,255,.16); color:var(--text); border-radius:8px; padding:6px 10px;}
  .modal .form-field label{color:var(--muted);}
  .modal input, .modal select, .modal textarea{
    background: rgba(255,255,255,.08);
    border: 1px solid rgba(255,255,255,.22);
    color: var(--text);
    caret-color: var(--text);
  }
  .modal input:focus, .modal select:focus, .modal textarea:focus{
    border-color: var(--accent1);
    box-shadow: 0 0 0 3px rgba(6,215,255,.12);
  }
  .modal select option, .modal select optgroup{ background-color:#0a0e1d; color: var(--text); }
  .modal input::placeholder, .modal textarea::placeholder{ color: var(--muted); opacity:.9; }

  /* Responsive */
  @media (max-width:1200px){
    .app{grid-template-columns: 220px 1fr 0; grid-template-rows: 72px 1fr}
    .rail{display:none}
    .proj{grid-column: span 12}
    .kpi{grid-column: span 6}
  }
  @media (max-width:820px){
    .side{display:none}
    .app{grid-template-columns:1fr}
    .kpi{grid-column: span 12}
  }
</style>
</head>
<body>
<div class="dots"></div>

<div class="app">

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">TG</div>
      <h1>TaskGrid</h1>
      <span id="roleBadge" class="role-badge">Role: ‚Ä¶</span>
      <span id="topUserName" style="margin-left:10px; font-weight:600; opacity:.9;"></span>
    </div>
    <div class="top-actions">
      <!-- role switcher for demo -->
      <select id="roleSwitch" class="select" title="Switch role">
        <option value="Member">Member</option>
        <option value="Manager">Manager</option>
        <option value="Admin">Admin</option>
      </select>
      <button class="btn-ghost" id="searchBtn">Search</button>
      <button class="btn" onclick="logout()">Logout</button>
    </div>
  </header>

  <!-- Sidebar -->
  <aside class="side">
    <nav id="menu" class="menu"></nav>
  </aside>

  <!-- Main content -->
  <main class="main">
    <div class="grid" id="content">
      <!-- KPI Row -->
      <div class="card kpi">
        <h4>Open Tasks</h4>
        <div class="num" id="kpiTasks">0</div>
        <small>pending items</small>
      </div>
      <div class="card kpi">
        <h4>On Track</h4>
        <div class="num" id="kpiOnTrack">0%</div>
        <small>project health</small>
      </div>
      <div class="card kpi">
        <h4>Notifications</h4>
        <div class="num" id="kpiNotifs">0</div>
        <small>unread items</small>
      </div>

      <!-- Section header -->
      <div class="section-title" style="grid-column:1 / -1;">
        <h2 id="sectionTitle">Your Projects</h2>
        <div class="chips">
          <span class="chip" onclick="showCreateTaskForm()">+ Add Task</span>
          <span class="chip" onclick="showTimeline()">Timeline</span>
          <span class="chip" onclick="generateReport()">Reports</span>
        </div>
      </div>

      <!-- Project/Task cards container (filled by JS) -->
      <div id="cardsMount" class="grid" style="grid-column:1 / -1;"></div>
    </div>
  </main>

  <!-- Right rail -->
  <aside class="rail">
    <div class="card" style="margin-bottom:12px;">
      <div class="section-title">
        <h2>Recent Updates</h2>
        <span class="chip">Live</span>
      </div>
      <div id="updates"></div>
    </div>

    <div class="card">
      <div class="section-title">
        <h2>Notifications</h2>
        <span class="chip" id="notifFilter" onclick="toggleNotificationFilter()">All</span>
      </div>
      <div id="notifs"></div>
    </div>
  </aside>
</div>
<!-- Include configuration and API helper -->
<script src="./js/config.js"></script>
<script src="./js/api.js"></script>

<script>
/* ------- Centralized API config (use CONFIG from js/config.js) ------- */
const TOKEN_KEY = `${CONFIG.STORAGE_PREFIX}token`;
const USER_KEY  = `${CONFIG.STORAGE_PREFIX}user`;

// read token from storage on load
let authToken = localStorage.getItem(TOKEN_KEY);

// Load data from backend
async function loadUserData() {
  try {
    // Re-read token before each load (this ensures redirects if user logged out elsewhere)
    authToken = localStorage.getItem(TOKEN_KEY);
    if (!authToken) {
      // Redirect to login if no token
      window.location.href = '/login.html';
      return;
    }
    
    // Load user profile (prefer local, then backend)
    try {
      const stored = localStorage.getItem('taskgrid_user');
      if (stored) { try { setProfileFromUser(JSON.parse(stored)); } catch (e) {} }
      const prof = await window.apiCall('/auth/profile');
if (prof && prof.user) {
  // Save user locally for future sessions
  localStorage.setItem('taskgrid_user', JSON.stringify(prof.user));
  
  // Set profile info
  setProfileFromUser(prof.user);
  document.getElementById('topUserName').textContent = prof.user.first_name || prof.user.email;
  
  // Update topbar with real name and role
  const r = uiRoleFromBackend(prof.user.role);
  role = r;
  if (roleSwitch) roleSwitch.value = r;
  if (roleBadge) roleBadge.textContent = `Role: ${r}`;
  document.title = `TaskGrid ‚Äî ${prof.user.first_name || 'User'}'s Dashboard`;
}
    } catch (e) {
      // keep defaults/local if profile fails
    }

    // Load dashboard data
    const dashboardData = await window.apiCall('/data/dashboard');
    
    // Load projects
    const projectsData = await window.apiCall('/data/projects');
    // Normalize project ids to `id` (frontend expects `id`)
    const rawProjects = projectsData.projects || projectsData.data || projectsData || [];
    sample.projects = (Array.isArray(rawProjects) ? rawProjects : []).map(p => {
      // ensure consistent id property
      p.id = p.id || p._id || p._id?.$oid || p._id_str || p.owner_id || p._id;
      // keep original _id too
      p._id = p._id || p.id;
      return p;
    });
    console.log("‚úÖ Loaded projects from backend:", sample.projects);

    
    // Load tasks
   const tasksData = await window.apiCall('/data/tasks');
   const rawTasks = tasksData.tasks || tasksData.data || tasksData || [];
   // Normalize task ids and ensure project linkage keys are strings
   sample.tasksMine = (Array.isArray(rawTasks) ? rawTasks : []).map(t => {
     t.id = t.id || t._id || t._id?.$oid || t._id_str || t._id;
     t._id = t._id || t.id;
     // normalize project id to string (if present)
     if (t.project_id && typeof t.project_id !== 'string') {
       try { t.project_id = String(t.project_id); } catch(e) {}
     }
     // also normalize created/assigned user references to strings
     if (t.user_id && typeof t.user_id !== 'string') { try { t.user_id = String(t.user_id); } catch(e) {} }
     if (t.created_by && typeof t.created_by !== 'string') { try { t.created_by = String(t.created_by); } catch(e) {} }
     return t;
   });
   console.log("‚úÖ Loaded tasks from backend:", sample.tasksMine);

    // Load users (for members list)
    try {
      const usersData = await window.apiCall('/data/users');
      sample.members = usersData.users || [];
    } catch (error) {
      // If user doesn't have permission to view users, use empty array
      sample.members = [];
    }
    
    // Initialize notifications and updates
    sample.updates = [
      { t: "Dashboard loaded successfully!", kind: "ok", time: "Now" }
    ];
    
    sample.notifs = [
      { t: "Welcome to TaskGrid! Your data is now synced with the server.", kind: "ok", time: "Now", read: false, id: Date.now() }
    ];
    
    // Update UI
    updateRoleUI();
    renderMain();
    renderRightRail();
    fillKPIs();
    
  } catch (error) {
    console.error('Failed to load user data:', error);
    showToast('Failed to load data from server. Using offline mode.', 'warn');
    
    // Fallback to localStorage
    const userId = localStorage.getItem('taskgrid_user_id') || 'user_' + Date.now();
    localStorage.setItem('taskgrid_user_id', userId);
    
    const userData = localStorage.getItem(`taskgrid_data_${userId}`);
    if (userData) {
      sample = JSON.parse(userData);
    } else {
      // Initialize with empty data for new users
      sample = {
        projects: [],
        tasksMine: [],
        members: [
          { id: 1, first_name: "You", last_name: "", role: "team_member", avatar: "YU", status: "online" }
        ],
        updates: [
          { t: "Welcome to TaskGrid! Create your first task to get started.", kind: "ok", time: "Now" }
        ],
        notifs: [
          { t: "Welcome! Start by creating your first task with a deadline.", kind: "ok", time: "Now", read: false, id: Date.now() }
        ],
        profile: {
          name: "User",
          email: "user@taskgrid.com",
          role: "team_member",
          joinDate: new Date().toISOString().split('T')[0],
          avatar: "YU",
          preferences: {
            notifications: true,
            emailAlerts: true,
            theme: "dark"
          }
        }
      };
    }
    
    updateRoleUI();
    renderMain();
    renderRightRail();
    fillKPIs();
  }
}

function saveUserData(data) {
  // Save to localStorage as backup
  const userId = localStorage.getItem('taskgrid_user_id');
  if (userId) {
    localStorage.setItem(`taskgrid_data_${userId}`, JSON.stringify(data));
  }
  
  // Data is automatically saved to backend through API calls
  console.log('Data saved locally as backup');
}

// Map backend role to UI label
function uiRoleFromBackend(role){
  if (!role) return 'Member';
  const map = { admin:'Admin', manager:'Manager', team_member:'Member', member:'Member' };
  const key = String(role).toLowerCase();
  return map[key] || (key.charAt(0).toUpperCase()+key.slice(1));
}

// Populate sample.profile from backend/local user object
function setProfileFromUser(u){
  if (!u) return;
  const first = (u.first_name||u.firstName||'').trim();
  const last = (u.last_name||u.lastName||'').trim();
  const name = [first,last].filter(Boolean).join(' ') || u.username || u.email || 'User';
  const email = u.email || '';
  const roleLabel = uiRoleFromBackend(u.role||u.user_role);
  const joined = u.created_at || new Date().toISOString();
  const baseForInitials = (first ? `${first} ${last}` : (name||''));
  const initials = baseForInitials.split(' ').filter(Boolean).map(s=>s[0]).join('').toUpperCase().slice(0,2) || 'U';
  sample.profile = {
    name,
    email,
    role: roleLabel,
    joinDate: joined,
    avatar: initials,
    preferences: sample.profile?.preferences || { notifications:true, emailAlerts:true, theme:'dark' }
  };
}

/* ------- Utility functions ------- */
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 10000;
    background: ${type === 'success' ? '#2ad39a' : type === 'error' ? '#ff5d6c' : type === 'warn' ? '#ffb020' : '#06d7ff'};
    color: white; padding: 12px 20px; border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(100%);
    transition: transform 0.3s ease; max-width: 400px;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.style.transform = 'translateX(0)', 100);
  setTimeout(() => {
    toast.style.transform = 'translateX(100%)';
    setTimeout(() => toast.remove(), 300);
  }, 5000);
}

function formatDate(dateString) {
  if (!dateString) return 'No date';
  const date = new Date(dateString);
  const today = new Date();
  const diffTime = date - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) return 'Today';
  if (diffDays === 1) return 'Tomorrow';
  if (diffDays === -1) return 'Yesterday';
  if (diffDays < 0) return `${Math.abs(diffDays)} days overdue`;
  if (diffDays <= 7) return `${diffDays} days`;
  
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
}

function getDaysUntilDeadline(dueDate) {
  if (!dueDate) return null;
  const today = new Date();
  const deadline = new Date(dueDate);
  const diffTime = deadline - today;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

function getTaskStatus(task) {
  const daysUntil = getDaysUntilDeadline(task.due);
  if (task.status === 'completed') return 'completed';
  if (daysUntil < 0) return 'overdue';
  if (daysUntil <= 2) return 'due-soon';
  return 'normal';
}

/* ------- Role & shell wiring ------- */
const roleSwitch = document.getElementById('roleSwitch');
const roleBadge  = document.getElementById('roleBadge');
const menuMount  = document.getElementById('menu');
const cardsMount = document.getElementById('cardsMount');
const sectionTitle = document.getElementById('sectionTitle');

function detectRole(){
  try {
    const stored = localStorage.getItem('taskgrid_user');
    if (stored) {
      const u = JSON.parse(stored);
      const r = uiRoleFromBackend(u.role || u.user_role);
      if (roleSwitch) roleSwitch.value = r;
      return r;
    }
  } catch (e) {}
  const r = sample.profile?.role || 'Member';
  if (roleSwitch) roleSwitch.value = r;
  return r;
}

let role = detectRole();
// keep track of which section is active so renderMenu can mark it
let currentSection = 'Projects';
updateRoleUI();

roleSwitch.addEventListener('change', ()=>{
  role = roleSwitch.value;
  roleBadge.textContent = `Role: ${role}`;
  renderMenu();
  renderMain();
});

function updateRoleUI(){
  roleBadge.textContent = `Role: ${role}`;
  renderMenu();
  renderRightRail();
  renderMain();
  fillKPIs();
}

function renderMenu(){
  const groups = {
    Admin: [
      ["Projects","/projects"],
      ["Tasks","/tasks"],
      ["Users","/users"],
      ["Profile","/profile"]
    ],
    Manager: [
      ["Projects","/projects"],
      ["Tasks","/tasks"],
      ["Notifications","/notifications"],
      ["Profile","/profile"]
    ],
    Member: [
      ["Tasks","/tasks"],
      ["Projects","/projects"],
      ["Notifications","/notifications"],
      ["Profile","/profile"]
    ]
  };

  const icons = {
    Tasks: 'üìã',
    Projects: 'üìÅ',
    Notifications: 'üîî',
    'Report Analysis': 'üìä',
    Users: 'üë•',
    Profile: 'üë§'
  };

  const list = groups[role] || groups.Member;

  // Build menu items using data-section attributes (no inline onclick)
  menuMount.innerHTML = `<h3>Menu</h3>` + list.map(([label]) =>
    `<div class="item" data-section="${label}">
       <span style="margin-right:8px">${icons[label] || ''}</span>
       <span class="menu-label">${label}</span>
     </div>`
  ).join('');

  // Attach click handlers and set active class based on currentSection
  menuMount.querySelectorAll('.item').forEach(item => {
    const section = item.getAttribute('data-section');
    item.classList.toggle('active', section === currentSection || (section === 'Projects' && !currentSection));
    item.addEventListener('click', (e) => {
      // Update active styling
      menuMount.querySelectorAll('.item').forEach(i => i.classList.remove('active'));
      item.classList.add('active');

      // Save active section and navigate
      currentSection = section;
      navigateToSection(section);
    });
  });
}


function navigateToSection(section) {
  // Keep the active highlight in sync (in case called programmatically)
  currentSection = section;
  menuMount.querySelectorAll('.item').forEach(i => {
    i.classList.toggle('active', i.getAttribute('data-section') === section);
  });

  // Route to section logic (unchanged behavior)
  if (section === 'Profile') {
    showProfile();
  } else if (section === 'Notifications') {
    showNotifications();
  } else if (section === 'Tasks') {
    sectionTitle.textContent = "Your Tasks";
    renderMain();
  } else if (section === 'Projects') {
    sectionTitle.textContent = "Your Projects";
    renderMain();
  } else if (section === 'Reports') {
    // Navigate to the new Report Analysis page
    window.location.href = '../reports/analysis.html';
  } else if (section === 'Report Analysis') {
    showReportAnalysis();
  } else {
    showToast(`${section} section - Coming soon!`, 'info');
  }
}

/* ------- Profile Management ------- */
function showProfile() {
  sectionTitle.textContent = "Profile Settings";

  // ‚úÖ Always use the latest user info from localStorage or backend
  let user = null;
  try {
    user = JSON.parse(localStorage.getItem('taskgrid_user'));
  } catch (e) {}

  if (!user || !user.email) {
    // fallback: use default
    user = sample.profile;
  }

  const fullName = `${user.first_name || ''} ${user.last_name || ''}`.trim() || user.username || 'User';
  const email = user.email || 'Not available';
  const role = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : 'Member';
  const joinDate = user.created_at ? formatDate(user.created_at) : formatDate(sample.profile.joinDate);
  const initials = (user.first_name?.[0] || user.username?.[0] || 'U').toUpperCase();

  cardsMount.innerHTML = `
    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>Profile Information</h2>
        <span class="chip" onclick="editProfile()">Edit</span>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 20px; align-items: start;">
        <div style="text-align: center;">
          <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, var(--accent1), var(--accent2)); display: grid; place-items: center; font-size: 24px; font-weight: 800; margin: 0 auto 10px;">
            ${initials}
          </div>
          <h3 id="profile-name">${fullName}</h3>
          <p id="profile-role" style="color: var(--muted);">${role}</p>
        </div>
        <div>
          <div style="margin-bottom: 15px;">
            <strong>Email:</strong> <span id="profile-email">${email}</span>
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Role:</strong> ${role}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Joined:</strong> ${joinDate}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Tasks Created:</strong> ${sample.tasksMine.length}
          </div>
          <div style="margin-bottom: 15px;">
            <strong>Projects:</strong> ${sample.projects.length}
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>Preferences</h2>
      </div>
      <div style="display: grid; gap: 15px;">
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" ${sample.profile.preferences.notifications ? 'checked' : ''} onchange="togglePreference('notifications')">
          <span>Email Notifications</span>
        </label>
        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
          <input type="checkbox" ${sample.profile.preferences.emailAlerts ? 'checked' : ''} onchange="togglePreference('emailAlerts')">
          <span>Deadline Alerts</span>
        </label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span>Theme:</span>
          <select onchange="changeTheme(this.value)" style="background: var(--card); color: var(--text); border: 1px solid rgba(255,255,255,.1); padding: 5px; border-radius: 5px;">
            <option value="dark" ${sample.profile.preferences.theme === 'dark' ? 'selected' : ''}>Dark</option>
            <option value="light" ${sample.profile.preferences.theme === 'light' ? 'selected' : ''}>Light</option>
          </select>
        </div>
      </div>
    </div>
  `;
}

function editProfile() {
  const newName = prompt('Enter your name:', sample.profile.name);
  const newEmail = prompt('Enter your email:', sample.profile.email);
  
  if (newName && newEmail) {
    sample.profile.name = newName;
    sample.profile.email = newEmail;
    sample.profile.avatar = newName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    saveUserData(sample);
    showProfile();
    showToast('Profile updated successfully!', 'success');
  }
}

function togglePreference(pref) {
  sample.profile.preferences[pref] = !sample.profile.preferences[pref];
  saveUserData(sample);
  showToast(`${pref} ${sample.profile.preferences[pref] ? 'enabled' : 'disabled'}`, 'success');
}

function changeTheme(theme) {
  sample.profile.preferences.theme = theme;
  saveUserData(sample);
  showToast(`Theme changed to ${theme}`, 'success');
}

/* ------- Notifications Management ------- */
if (typeof showUnreadOnly === 'undefined') {
    var showUnreadOnly = false;
}


function showNotifications() {
  sectionTitle.textContent = "Notifications Center";
  const unreadCount = sample.notifs.filter(n => !n.read).length;
  
  cardsMount.innerHTML = `
    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>All Notifications (${sample.notifs.length})</h2>
        <div style="display: flex; gap: 8px;">
          <span class="chip" onclick="markAllAsRead()">Mark All Read</span>
          <span class="chip" onclick="clearAllNotifications()">Clear All</span>
        </div>
      </div>
      <div style="margin-bottom: 15px;">
        <span style="color: var(--muted);">Unread: ${unreadCount}</span>
      </div>
      <div id="notificationsList">
        ${sample.notifs.map(n => `
          <div class="notif ${!n.read ? 'unread' : ''}" onclick="markAsRead(${n.id || Date.now()})">
            <span class="dot ${n.kind}"></span>
            <div style="flex: 1;">
              <div>${n.t}</div>
              <small style="color: var(--muted); font-size: 10px;">${n.time}</small>
            </div>
            ${!n.read ? '<div style="width: 8px; height: 8px; background: var(--accent1); border-radius: 50%;"></div>' : ''}
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

function toggleNotificationFilter() {
  showUnreadOnly = !showUnreadOnly;
  document.getElementById('notifFilter').textContent = showUnreadOnly ? 'Unread' : 'All';
  updateNotifications();
}

function markAsRead(notifId) {
  const notif = sample.notifs.find(n => n.id === notifId);
  if (notif) {
    notif.read = true;
    saveUserData(sample);
    showToast('Notification marked as read', 'success');
    if (document.getElementById('notificationsList')) {
      showNotifications(); // Refresh if in notifications view
    }
    updateNotifications(); // Update sidebar
  }
}

function markAllAsRead() {
  sample.notifs.forEach(n => n.read = true);
  saveUserData(sample);
  showToast('All notifications marked as read', 'success');
  if (document.getElementById('notificationsList')) {
    showNotifications();
  }
  updateNotifications();
}

function clearAllNotifications() {
  if (confirm('Are you sure you want to clear all notifications?')) {
    sample.notifs = [];
    saveUserData(sample);
    showToast('All notifications cleared', 'success');
    if (document.getElementById('notificationsList')) {
      showNotifications();
    }
    updateNotifications();
  }
}

/* ------- Enhanced Project Card with deadline features ------- */
function ProjectCard(p){
  const el = document.createElement('div');
  el.className = 'card proj';
  
  const daysUntil = getDaysUntilDeadline(p.deadline);
  let deadlineStatus = '';
  let deadlineColor = 'var(--muted)';
  
  if (p.deadline) {
    if (daysUntil < 0) {
      deadlineStatus = `${Math.abs(daysUntil)} days overdue`;
      deadlineColor = 'var(--bad)';
    } else if (daysUntil <= 7) {
      deadlineStatus = `Due in ${daysUntil} days`;
      deadlineColor = daysUntil <= 2 ? 'var(--warn)' : 'var(--ok)';
    } else {
      deadlineStatus = `Due ${formatDate(p.deadline)}`;
    }
  } else {
    deadlineStatus = 'No deadline set';
  }
  
  // Calculate progress from backend data or default to 0
  const progress = p.get_progress ? p.get_progress() : (p.progress || 0);
  const taskCount = p.task_count || p.openTasks || 0;
  const ownerName = p.owner_name || p.owner || 'Unknown';
  
  el.innerHTML = `
    <h3>${p.name}</h3>
    <div class="meta">
      <span>Owner: ${ownerName}</span> ‚Ä¢ 
      <span>${taskCount} tasks</span> ‚Ä¢ 
      <span style="color: ${deadlineColor}">${deadlineStatus}</span>
    </div>
    <div class="progress"><i style="width:${progress}%"></i></div>
    <div class="assignees">
      <span class="pill">${p.status === 'active' ? 'Active' : p.status}</span>
      <span class="pill">Progress ${progress}%</span>
      <span class="pill" onclick="showProjectTimeline(${p.id})">üìÖ Timeline</span>
    </div>
  `;
  el.style.gridColumn = 'span 6';
  return el;
}

/* ------- Enhanced Task Card with deadline features ------- */
function TaskCard(t){
  const el = document.createElement('div');
  el.className = 'card proj';
  
  // Handle both due_date (backend) and due (frontend) properties
  const dueDate = t.due_date || t.due;
  const taskStatus = getTaskStatus({...t, due: dueDate});
  const daysUntil = getDaysUntilDeadline(dueDate);
  
  let statusColor = 'var(--muted)';
  let statusText = formatDate(dueDate);
  
  if (taskStatus === 'overdue') {
    statusColor = 'var(--bad)';
    statusText = `${Math.abs(daysUntil)} days overdue`;
  } else if (taskStatus === 'due-soon') {
    statusColor = 'var(--warn)';
    statusText = `Due in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`;
  } else if (taskStatus === 'completed') {
    statusColor = 'var(--ok)';
    statusText = 'Completed';
  }
  
  // Calculate progress (backend tasks might not have progress field)
  const progress = t.progress || 0;
  const projectName = t.project_name || t.project || 'Unknown Project';
  const assigneeName = t.assignee_name || t.assignee || 'Unassigned';
  
  el.innerHTML = `
    <h3>${t.title}</h3>
    <div class="meta">
      <span>${projectName}</span> ‚Ä¢ 
      <span style="color: ${statusColor}">${statusText}</span> ‚Ä¢ 
      <span>Priority: ${t.priority}</span>
    </div>
    <div class="progress"><i style="width:${progress}%"></i></div>
    <div class="assignees">
      <span class="pill">${assigneeName}</span>
      <span class="pill">Progress ${progress}%</span>
      <span class="pill" onclick="updateTaskProgress(${t.id})">üìà Update</span>
      <span class="pill" onclick="assignTask(${t.id})">üë• Assign</span>
    </div>
  `;
  el.style.gridColumn = 'span 6';
  return el;
}

/* ------- Enhanced Admin Panel ------- */
function AdminPanel(){
  const el = document.createElement('div');
  el.className = 'card';
  el.style.gridColumn = '1 / -1';
  el.innerHTML = `
    <div class="section-title" style="margin-bottom:8px;">
      <h2>Quick Actions</h2>
      <span class="chip">Enhanced</span>
    </div>
    <div style="display:flex; gap:12px; flex-wrap:wrap;">
      <button class="btn-ghost" onclick="showCreateTaskForm()">‚ûï Add Task</button>
      <button class="btn-ghost" onclick="showMembers()">üë• View Members</button>
      <button class="btn-ghost" onclick="generateReport()">üìä Generate Report</button>
      <button class="btn-ghost" onclick="showDeadlines()">üìÖ View Deadlines</button>
      <button class="btn-ghost" onclick="exportData()">üíæ Export Data</button>
      <button class="btn-ghost" onclick="showProfile()">üë§ Profile</button>
    </div>
  `;
  return el;
}

/* ------- Main area ------- */
function renderMain(){
  cardsMount.innerHTML = '';
  
  if (sample.tasksMine.length === 0 && sample.projects.length === 0) {
    // Show empty state for new users
    cardsMount.innerHTML = `
      <div class="empty-state">
        <i>‚úÖ</i>
        <h3>Welcome to TaskGrid!</h3>
        <p>You don't have any tasks yet. Create your first task with a deadline to get started.</p>
        <button class="btn" onclick="showCreateTaskForm()" style="margin-top: 16px;">Create Your First Task</button>
      </div>
    `;
    return;
  }
  
  if(role==='Admin'){
    sectionTitle.textContent = "Workspace Projects";
    sample.projects.forEach(p => cardsMount.appendChild(ProjectCard(p)));
    cardsMount.appendChild(AdminPanel());
  }else if(role==='Manager'){
    sectionTitle.textContent = "Projects & Team Tasks";
    sample.projects.forEach(p => cardsMount.appendChild(ProjectCard(p)));
    sample.tasksMine.forEach(t => cardsMount.appendChild(TaskCard(t)));
  }else{
    sectionTitle.textContent = "Your Tasks";
    sample.tasksMine.forEach(t => cardsMount.appendChild(TaskCard(t)));
  }
  
  // Always show admin panel for easy access
  if (sample.tasksMine.length > 0 || sample.projects.length > 0) {
    cardsMount.appendChild(AdminPanel());
  }
  
  // Update notifications after rendering
  updateNotifications();
}

/* ------- Right rail ------- */
function renderRightRail(){
  document.getElementById('updates').innerHTML =
    sample.updates.map(u => `
      <div class="notif"><span class="dot ${u.kind}"></span><div>${u.t}<br><small style="color: var(--muted); font-size: 10px;">${u.time}</small></div></div>
    `).join('');

  updateNotifications();
}

/* ------- KPIs ------- */
function fillKPIs(){
  const proj = sample.projects.length;
  const openTasks = sample.tasksMine.filter(t => t.status !== 'completed').length;
  const onTrack = sample.projects.length > 0 ? Math.round(
    (sample.projects.filter(p=>p.health==='ok').length / proj) * 100
  ) : 0;
  const unreadNotifs = sample.notifs.filter(n => !n.read).length;

  // Guard DOM updates ‚Äî some KPI elements may not exist in this layout
  const elProjects = document.getElementById('kpiProjects');
  const elTasks = document.getElementById('kpiTasks');
  const elOnTrack = document.getElementById('kpiOnTrack');
  const elNotifs = document.getElementById('kpiNotifs');

  if (elProjects) elProjects.textContent = proj;
  if (elTasks) elTasks.textContent = openTasks;
  if (elOnTrack) elOnTrack.textContent = onTrack + '%';
  if (elNotifs) elNotifs.textContent = unreadNotifs;
}

  /* ------- Enhanced Functions ------- */

// Timeline functionality
function showProjectTimeline(projectId) {
  const project = sample.projects.find(p => p.id === projectId);
  if (!project) return;
  
  showToast(`üìÖ Timeline for ${project.name}:\nStart: ${formatDate(project.startDate)}\nDeadline: ${formatDate(project.deadline)}\nProgress: ${project.progress}%`, 'info');
}

function showTimeline() {
  if (sample.tasksMine.length === 0) {
    showToast('No tasks to show in timeline. Create a task first!', 'info');
    return;
  }
  
  const upcomingTasks = sample.tasksMine
    .filter(t => t.due)
    .sort((a, b) => new Date(a.due) - new Date(b.due))
    .slice(0, 5);
  
  const timelineText = upcomingTasks
    .map(t => `${t.title}: ${formatDate(t.due)} (${t.status})`)
    .join('\n');
  
  showToast(`üìÖ Upcoming Timeline:\n${timelineText}`, 'info');
}

// Task progress update
function updateTaskProgress(taskId) {
  const task = sample.tasksMine.find(t => t.id === taskId);
  if (!task) return;
  
  const newProgress = prompt(`Update progress for "${task.title}" (current: ${task.progress}%):`, task.progress);
  if (newProgress !== null && !isNaN(newProgress) && newProgress >= 0 && newProgress <= 100) {
    task.progress = parseInt(newProgress);
    if (newProgress == 100) {
      task.status = 'completed';
      // Add completion notification
      sample.notifs.unshift({
        t: `‚úÖ Task completed: ${task.title}`,
        kind: 'ok',
        time: 'Now',
        read: false,
        id: Date.now()
      });
    }
    saveUserData(sample);
    showToast(`Progress updated to ${newProgress}%`, 'success');
    renderMain();
    updateNotifications();
  }
}

// Task assignment
function assignTask(taskId) {
  const task = sample.tasksMine.find(t => t.id === taskId);
  if (!task) return;
  
  const membersList = sample.members.map(m => `${m.name} (${m.role})`).join('\n');
  const selectedMember = prompt(`Assign "${task.title}" to:\n\n${membersList}\n\nEnter member name:`);
  
  if (selectedMember) {
    const member = sample.members.find(m => m.name.toLowerCase().includes(selectedMember.toLowerCase()));
    if (member) {
      task.assignee = member.name;
      saveUserData(sample);
      showToast(`Task assigned to ${member.name}`, 'success');
      renderMain();
    } else {
      showToast('Member not found', 'error');
    }
  }
}

// Enhanced Add Task functionality with REQUIRED dates and backend integration
async function addNewTask() {
  const title = prompt('Task title (required):');
  if (!title || title.trim() === '') {
    showToast('Task title is required!', 'error');
    return;
  }
  
  const description = prompt('Task description (optional):') || '';
  
  // Get or create project
  let projectId = null;
  if (sample.projects.length > 0) {
    const projectsList = sample.projects.map((p, index) => `${index + 1}. ${p.name}`).join('\n');
    const projectChoice = prompt(`Select existing project or create new:\n\n${projectsList}\n\nEnter project number (1-${sample.projects.length}) or type new project name:`);
    
    if (projectChoice && !isNaN(projectChoice) && projectChoice >= 1 && projectChoice <= sample.projects.length) {
      projectId = (sample.projects[parseInt(projectChoice) - 1]._id || sample.projects[parseInt(projectChoice) - 1].id);
    } else if (projectChoice && projectChoice.trim()) {
      // Create new project
      try {
        const newProject = await window.apiCall('/data/projects', 'POST', {
          name: projectChoice.trim(),
          description: `Project for ${title}`,
          status: 'active',
          priority: 'medium'
        });
        projectId = newProject.project._id || newProject.project.id;
        showToast('New project created!', 'success');
        // Refresh projects list
        const projectsData = await window.apiCall('/data/projects');
        sample.projects = projectsData.projects || [];
      } catch (error) {
        showToast('Failed to create project. Using offline mode.', 'warn');
        // Fallback to local project creation
        const localProject = {
          id: Date.now(),
          name: projectChoice.trim(),
          description: `Project for ${title}`,
          status: 'active',
          priority: 'medium',
          progress: 0,
          owner: 'You',
          openTasks: 1,
          health: 'ok',
          deadline: null
        };
        sample.projects.push(localProject);
        projectId = localProject.id;
      }
    } else {
      showToast('Project selection is required!', 'error');
      return;
    }
  } else {
    // No existing projects, create new one
    const projectName = prompt('Project name (required):');
    if (!projectName || projectName.trim() === '') {
      showToast('Project name is required!', 'error');
      return;
    }
    
    try {
      const newProject = await window.apiCall('/data/projects', 'POST', {
        name: projectName.trim(),
        description: `Project for ${title}`,
        status: 'active',
        priority: 'medium'
      });
      projectId = newProject.project._id || newProject.project.id;
      showToast('New project created!', 'success');
      // Refresh projects list
      const projectsData = await window.apiCall('/data/projects');
      sample.projects = projectsData.projects || [];
    } catch (error) {
      showToast('Failed to create project. Using offline mode.', 'warn');
      // Fallback to local project creation
      const localProject = {
        id: Date.now(),
        name: projectName.trim(),
        description: `Project for ${title}`,
        status: 'active',
        priority: 'medium',
        progress: 0,
        owner: 'You',
        openTasks: 1,
        health: 'ok',
        deadline: null
      };
      sample.projects.push(localProject);
      projectId = localProject.id;
    }
  }
  
  // Start date is required
  const startDate = prompt('Start date (YYYY-MM-DD, required):', new Date().toISOString().split('T')[0]);
  if (!startDate || !isValidDate(startDate)) {
    showToast('Valid start date is required!', 'error');
    return;
  }
  
  // Due date is required
  const dueDate = prompt('Due date (YYYY-MM-DD, required):');
  if (!dueDate || !isValidDate(dueDate)) {
    showToast('Valid due date is required!', 'error');
    return;
  }
  
  // Validate that due date is after start date
  if (new Date(dueDate) <= new Date(startDate)) {
    showToast('Due date must be after start date!', 'error');
    return;
  }
  
  const priority = prompt('Priority (low/medium/high/urgent):', 'medium');
  const validPriorities = ['low', 'medium', 'high', 'urgent'];
  const taskPriority = validPriorities.includes(priority?.toLowerCase()) ? priority.toLowerCase() : 'medium';
  
  // Estimate hours
  const estimatedHours = prompt('Estimated hours (optional):') || '0';
  const hours = parseFloat(estimatedHours) || 0;
  const notifyPhone = prompt('Enter SMS number for reminders (optional, e.g., +15551234567):') || '';
  
  try {
    // Create task via API
    const newTaskData = await window.apiCall('/data/tasks', 'POST', {
      title: title.trim(),
      description: description,
      project_id: projectId,
      priority: taskPriority,
      estimated_hours: hours,
      start_date: startDate,
      due_date: dueDate,
      status: 'todo',
      notify_phone: notifyPhone ? notifyPhone.trim() : undefined
    });
    
    // Refresh data from server so UI shows canonical server state
    try {
      await loadUserData();
    } catch (e) {
      console.warn('Failed to refresh after create, will use local update', e);
    }

    showToast('Task created successfully and saved to server!', 'success');
    renderMain();
    updateNotifications();
    return;
  } catch (error) {
    showToast('Failed to save to server. Task saved locally.', 'warn');
    
    // Fallback to local task creation
    const newTask = {
      id: Date.now(),
      title: title.trim(),
      project: sample.projects.find(p => p.id === projectId)?.name || 'Unknown Project',
      project_id: projectId,
      description: description,
      progress: 0,
      due: dueDate,
      due_date: dueDate,
      start_date: startDate,
      priority: taskPriority,
      status: 'todo',
      estimated_hours: hours,
      assignee: 'You',
      created: new Date().toISOString()
    };
    
    sample.tasksMine.push(newTask);
    
    // Add notification for new task
    sample.notifs.unshift({
      t: `üìù New task created: ${newTask.title}`,
      kind: 'ok',
      time: 'Now',
      read: false,
      id: Date.now() + 1
    });
    
    // Add deadline notification if due soon
    const daysUntil = getDaysUntilDeadline(dueDate);
    if (daysUntil <= 7) {
      sample.notifs.unshift({
        t: `‚è∞ Task "${newTask.title}" is due in ${daysUntil} day${daysUntil !== 1 ? 's' : ''}`,
        kind: 'warn',
        time: 'Now',
        read: false,
        id: Date.now() + 2
      });
    }
    
    saveUserData(sample);
    showToast('Task created successfully with deadline!', 'success');
    renderMain();
    updateNotifications();
  }
}

/* ------- Create Task Page ------- */
function showCreateTaskForm(){
  const projectsOptions = sample.projects.map(p => `<option value="${p._id || p.id}">${p.name}</option>`).join('');
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay';
  overlay.id = 'createTaskOverlay';
  overlay.innerHTML = `
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="createTaskTitle">
      <div class="modal-header">
        <h2 id="createTaskTitle" style="margin:0;font-size:18px;">New Task</h2>
        <button class="close-x" id="createTaskCloseBtn">Close</button>
      </div>
      <div class="modal-body">
        <form id="createTaskForm" class="form-grid">
          <div class="form-field full">
            <label>Title *</label>
            <input type="text" name="title" required placeholder="Enter task title" />
          </div>
          <div class="form-field full">
            <label>Description</label>
            <textarea name="description" rows="4" placeholder="Optional description"></textarea>
          </div>
          <div class="form-field">
            <label>Project</label>
            <select name="project_id" id="projectSelect">
              ${projectsOptions ? `<option value="">Select a project</option>${projectsOptions}` : ''}
              <option value="__new__">+ Create new project</option>
            </select>
          </div>
          <div class="form-field" id="newProjectNameWrap" style="display:${projectsOptions ? 'none':'block'};">
            <label>New Project Name ${projectsOptions ? '' : '*'}</label>
            <input type="text" id="newProjectName" placeholder="Enter new project name" ${projectsOptions ? '' : 'required'} />
          </div>
          <div class="form-field full" id="newProjectDescWrap" style="display:${projectsOptions ? 'none':'block'};">
            <label>New Project Description</label>
            <textarea id="newProjectDesc" rows="3" placeholder="Optional"></textarea>
          </div>
          <div class="form-field">
            <label>Start Date *</label>
            <input type="date" name="start_date" required value="${new Date().toISOString().split('T')[0]}" />
          </div>
          <div class="form-field">
            <label>Due Date *</label>
            <input type="date" name="due_date" required />
          </div>
          <div class="form-field">
            <label>Priority</label>
            <select name="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
          <div class="form-field">
            <label>Estimated Hours</label>
            <input type="number" name="estimated_hours" min="0" step="0.5" placeholder="e.g., 4" />
          </div>
          <div class="form-field">
            <label>SMS Number (optional)</label>
            <input type="tel" name="notify_phone" placeholder="+15555555555" />
          </div>
          <div class="modal-actions full">
            <button type="button" class="btn-ghost" id="createTaskCancelBtn">Cancel</button>
            <button type="submit" class="btn">Create Task</button>
          </div>
        </form>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  document.body.style.overflow = 'hidden';

  const sel = overlay.querySelector('#projectSelect');
  const newName = overlay.querySelector('#newProjectNameWrap');
  const newDesc = overlay.querySelector('#newProjectDescWrap');
  if (sel) sel.addEventListener('change', ()=>{
    if (sel.value === '__new__' || sel.value === '') {
      newName.style.display = 'block';
      newDesc.style.display = 'block';
      const nameInput = overlay.querySelector('#newProjectName');
      if (nameInput) nameInput.required = true;
    } else {
      newName.style.display = 'none';
      newDesc.style.display = 'none';
      const nameInput = overlay.querySelector('#newProjectName');
      if (nameInput) nameInput.required = false;
    }
  });

  const form = overlay.querySelector('#createTaskForm');
  form.addEventListener('submit', submitCreateTaskForm);

  overlay.querySelector('#createTaskCloseBtn').onclick = closeCreateTaskModal;
  overlay.querySelector('#createTaskCancelBtn').onclick = closeCreateTaskModal;
  overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeCreateTaskModal(); });

  window._tgEscHandler = (ev)=>{ if(ev.key === 'Escape') closeCreateTaskModal(); };
  document.addEventListener('keydown', window._tgEscHandler);
}

function closeCreateTaskModal(){
  const overlay = document.getElementById('createTaskOverlay');
  if (overlay) overlay.remove();
  document.body.style.overflow = '';
  if (window._tgEscHandler) {
    document.removeEventListener('keydown', window._tgEscHandler);
    window._tgEscHandler = null;
  }
}

async function submitCreateTaskForm(e){
  e.preventDefault();
  const form = e.target;
  const data = Object.fromEntries(new FormData(form).entries());
  const title = (data.title || '').trim();
  if (!title) { showToast('Task title is required!', 'error'); return; }
  const start_date = data.start_date;
  const due_date = data.due_date;
  if (!isValidDate(start_date) || !isValidDate(due_date)) { showToast('Enter valid dates (YYYY-MM-DD)', 'error'); return; }
  if (new Date(due_date) <= new Date(start_date)) { showToast('Due date must be after start date!', 'error'); return; }

  const priority = (data.priority || 'medium').toLowerCase();
  const estimated_hours = parseFloat(data.estimated_hours || '0') || 0;
  let project_id = (data.project_id && data.project_id !== '__new__') ? data.project_id : null;


  // Create project if needed
  if (!project_id) {
    const name = (document.getElementById('newProjectName')?.value || '').trim();
    if (!name) { showToast('Project name is required', 'error'); return; }
    const description = document.getElementById('newProjectDesc')?.value || `Project for ${title}`;
    try {
      const newProject = await window.apiCall('/data/projects', 'POST', { name, description, status:'active', priority:'medium' });
      project_id = newProject.project._id || newProject.project.id;

      try {
        const projectsData = await window.apiCall('/data/projects');
        sample.projects = projectsData.projects || [];
      } catch {}
    } catch (err) {
      const localProject = { id: Date.now(), name, description, status:'active', priority:'medium', progress:0, owner:'You', openTasks:0, health:'ok', deadline:null };
      sample.projects.push(localProject);
      project_id = localProject.id;
      showToast('Project created locally (offline)', 'warn');
    }
  }

  try {
    const newTaskData = await window.apiCall('/data/tasks', 'POST', {
      title,
      description: data.description || '',
      project_id,
      priority,
      estimated_hours,
      start_date,
      due_date,
      status: 'todo',
      notify_phone: (data.notify_phone || '').trim() || undefined
    });

    // Ensure UI reflects server state: refresh tasks & projects
    try {
      await loadUserData();
    } catch (err) {
      console.warn('Failed to refresh data after task create', err);
      // fallback: merge the returned task into local sample (existing behavior)
      const newTask = {
        id: newTaskData.task._id || newTaskData.task.id,
        title,
        project: sample.projects.find(p => (p._id || p.id) === project_id)?.name || 'Unknown Project',
        project_id,
        description: data.description || '',
        progress: 0,
        due: due_date,
        due_date,
        start_date,
        priority,
        status: 'todo',
        estimated_hours,
        assignee: 'You',
        created: newTaskData.task.created_at || new Date().toISOString()
      };
      sample.tasksMine.push(newTask);
    }

    saveUserData(sample);
    showToast('Task created successfully!', 'success');
    closeCreateTaskModal();
    renderMain();
    updateNotifications();
  } catch (error) {
    const newTask = {
      id: Date.now(),
      title,
      project: sample.projects.find(p => p.id === project_id)?.name || 'Unknown Project',
      project_id,
      description: data.description || '',
      progress: 0,
      due: due_date,
      due_date,
      start_date,
      priority,
      status: 'todo',
      estimated_hours,
      assignee: 'You',
      created: new Date().toISOString()
    };
    sample.tasksMine.push(newTask);
    saveUserData(sample);
    showToast('Task created locally (offline)', 'warn');
    closeCreateTaskModal();
    renderMain();
    updateNotifications();
  }
}

function isValidDate(dateString) {
  const date = new Date(dateString);
  return date instanceof Date && !isNaN(date) && dateString.match(/^\d{4}-\d{2}-\d{2}$/);
}

// Enhanced notifications with deadline alerts
function updateNotifications() {
  const overdueTasks = sample.tasksMine.filter(t => getTaskStatus(t) === 'overdue');
  const dueSoonTasks = sample.tasksMine.filter(t => getTaskStatus(t) === 'due-soon');
  
  const deadlineNotifs = [];
  
  overdueTasks.forEach(task => {
    const days = Math.ceil((new Date() - new Date(task.due_date||task.due)) / (1000*60*60*24));
    deadlineNotifs.push({
      t: `üö® OVERDUE: ${task.title} (${days} day${days !== 1 ? 's' : ''} overdue)`,
      kind: 'bad',
      time: 'Now',
      read: false,
      id: `overdue_${task.id}`
    });
  });
  
  dueSoonTasks.forEach(task => {
    const days = getDaysUntilDeadline(task.due);
    deadlineNotifs.push({
      t: `‚è∞ Due ${days === 0 ? 'today' : `in ${days} day${days !== 1 ? 's' : ''}`}: ${task.title}`,
      kind: 'warn',
      time: 'Now',
      read: false,
      id: `due_soon_${task.id}`
    });
  });
  
  // Merge deadline notifications with existing ones (avoid duplicates)
  deadlineNotifs.forEach(deadlineNotif => {
    const exists = sample.notifs.find(n => n.id === deadlineNotif.id);
    if (!exists) {
      sample.notifs.unshift(deadlineNotif);
    }
  });
  
  // Filter notifications based on current filter
  const notifsToShow = showUnreadOnly ? 
    sample.notifs.filter(n => !n.read) : 
    sample.notifs;
  
  // Update notifications display
  document.getElementById('notifs').innerHTML = notifsToShow.slice(0, 10).map(n => `
    <div class="notif ${!n.read ? 'unread' : ''}" onclick="markAsRead('${n.id}')">
      <span class="dot ${n.kind}"></span>
      <div style="flex: 1;">
        <div>${n.t}</div>
        <small style="color: var(--muted); font-size: 10px;">${n.time}</small>
      </div>
      ${!n.read ? '<div style="width: 8px; height: 8px; background: var(--accent1); border-radius: 50%;"></div>' : ''}
    </div>
  `).join('');
  
  // Update notification count in KPI
  fillKPIs();
}

// Member management
function showMembers() {
  sectionTitle.textContent = "Team Members";
  const members = sample.members && sample.members.length ? sample.members : [];
  const names = members
    .map(m => (m.first_name || m.last_name)
      ? `${(m.first_name||'').trim()} ${(m.last_name||'').trim()}`.trim()
      : (m.name || 'Unknown'))
    .filter(n => n);

  const listHtml = names.length
    ? names.map(n => `<div class="notif"><div style="flex:1;"><strong>${n}</strong></div></div>`).join('')
    : `<div class="empty-state"><i>üë•</i><h3>No members found</h3><p>Members will appear here once available.</p></div>`;

  cardsMount.innerHTML = `
    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>All Members (${names.length})</h2>
        <span class="chip" onclick="renderMain()">Back</span>
      </div>
      <div style="display:grid; gap:10px;">${listHtml}</div>
    </div>
  `;
}

// Report generation
function generateReport() {
  sectionTitle.textContent = "Reports";
  const totalTasks = sample.tasksMine.length;
  const completedTasks = sample.tasksMine.filter(t => t.status === 'completed').length;
  const overdueTasks = sample.tasksMine.filter(t => getTaskStatus({...t, due: t.due_date || t.due}) === 'overdue').length;
  const avgProgress = totalTasks > 0 ? Math.round(sample.tasksMine.reduce((sum, t) => sum + (t.progress||0), 0) / totalTasks) : 0;
  const activeProjects = sample.projects.length;
  const unread = sample.notifs.filter(n => !n.read).length;

  const byPriority = sample.tasksMine.reduce((acc,t)=>{ const p=(t.priority||'medium').toLowerCase(); acc[p]=(acc[p]||0)+1; return acc;}, {});
  const byStatus = sample.tasksMine.reduce((acc,t)=>{ const s=(t.status||'todo').toLowerCase(); acc[s]=(acc[s]||0)+1; return acc;}, {});

  function bar(count,max){const pct=max?Math.round((count/max)*100):0; return `<div style="height:8px;background:rgba(255,255,255,.1);border-radius:999px;overflow:hidden;"><i style="display:block;height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent1),var(--accent2));"></i></div>`;}



  const maxCount = Math.max(1, ...Object.values({...byPriority, ...byStatus}));

  const priorityHtml = Object.entries(byPriority).map(([k,v])=>`<div><div style="display:flex;justify-content:space-between;"><span>${k}</span><span>${v}</span></div>${bar(v,maxCount)}</div>`).join('');
  const statusHtml = Object.entries(byStatus).map(([k,v])=>`<div><div style="display:flex;justify-content:space-between;"><span>${k}</span><span>${v}</span></div>${bar(v,maxCount)}</div>`).join('');

  const projectBreakdown = sample.projects.map(p=>{
    const count = sample.tasksMine.filter(t => t.project_id === (p._id || p.id)).length;
    const progress = p.get_progress ? p.get_progress() : (p.progress || 0);
    return `<div class="notif"><div style="flex:1;"><div><strong>${p.name}</strong></div><div style="color:var(--muted);font-size:12px;">Tasks: ${count} ‚Ä¢ Progress: ${progress}%${p.deadline?` ‚Ä¢ Deadline: ${formatDate(p.deadline)}`:''}</div></div>`;
  }).join('') || `<div class="empty-state"><i>üìÅ</i><h3>No projects</h3></div>`;

  cardsMount.innerHTML = `
    <div class="grid" style="grid-column:1 / -1;">
      <div class="card kpi"><h4>Total Tasks</h4><div class="num">${totalTasks}</div></div>
      <div class="card kpi"><h4>Completed</h4><div class="num">${completedTasks}</div></div>
      <div class="card kpi"><h4>Overdue</h4><div class="num">${overdueTasks}</div></div>
      <div class="card kpi"><h4>Avg Progress</h4><div class="num">${avgProgress}%</div></div>
    </div>
    <div class="card" style="grid-column:1 / -1;">
      <div class="section-title"><h2>Report Summary</h2><span class="chip" onclick="renderMain()">Back</span></div>
      <div style="display:grid;grid-template-columns:repeat(12,1fr);gap:16px;">
        <div class="card" style="grid-column:span 6;">
          <div class="section-title"><h2>By Priority</h2></div>
          <div style="display:grid;gap:10px;">${priorityHtml || '<span style="color:var(--muted);">No tasks</span>'}</div>
        </div>
        <div class="card" style="grid-column:span 6;">
          <div class="section-title"><h2>By Status</h2></div>
          <div style="display:grid;gap:10px;">${statusHtml || '<span style=\"color:var(--muted);\">No tasks</span>'}</div>
        </div>
        <div class="card" style="grid-column:1 / -1;">
          <div class="section-title"><h2>Projects</h2><span class="chip">Unread: ${unread}</span></div>
          <div style="display:grid;gap:10px;">${projectBreakdown}</div>
        </div>
      </div>
    </div>
  `;
}

/* ------- Report Analysis (Charts + Export) ------- */
const _loadedDeps = { chart:false, jspdf:false };
function loadScriptOnce(src){
  return new Promise((resolve, reject)=>{
    if (document.querySelector(`script[src="${src}"]`)) return resolve();
    const s=document.createElement('script'); s.src=src; s.onload=resolve; s.onerror=reject; document.head.appendChild(s);
  });
}
async function ensureReportDeps(){
  if (!_loadedDeps.chart) {
    await loadScriptOnce('https://cdn.jsdelivr.net/npm/chart.js');
    _loadedDeps.chart = true;
  }
  if (!_loadedDeps.jspdf) {
    await loadScriptOnce('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
    _loadedDeps.jspdf = true;
  }
}

function exportPDF(){
  const jspdf = window.jspdf; if (!jspdf) { showToast('PDF library not loaded', 'error'); return; }
  const doc = new jspdf.jsPDF();
  doc.text('Reports & Analytics Dashboard', 20, 20);
  doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 30);
  doc.save('report-analysis.pdf');
}

function exportCSV(){
  const rows = [
    ['Metric','Value'],
  ];
  const tasks = sample.tasksMine || [];
  const completed = tasks.filter(t=> (t.status||'').toLowerCase()==='completed').length;
  const total = tasks.length; const pending = total - completed;
  rows.push(['Completed Tasks', `${completed}`]);
  rows.push(['Pending Tasks', `${pending}`]);
  const csv = rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='report-analysis.csv'; a.click(); URL.revokeObjectURL(url);
}

async function showReportAnalysis(){
  sectionTitle.textContent = 'Reports & Analytics Dashboard';
  cardsMount.innerHTML = `
    <div class="card" style="grid-column:1 / -1; display:flex; justify-content:space-between; align-items:center;">
      <h2 style="margin:0; font-size:20px;">Reports & Analytics Dashboard</h2>
      <div style="display:flex; gap:10px;">
        <button class="btn-ghost" onclick="exportPDF()">Export PDF</button>
        <button class="btn" onclick="exportCSV()">Export CSV</button>
      </div>
    </div>
    <div class="card" style="grid-column: span 6;">
      <h3>Task Completion %</h3>
      <canvas id="tgPie" height="260"></canvas>
    </div>
    <div class="card" style="grid-column: span 6;">
      <h3>Tasks per User</h3>
      <canvas id="tgBar" height="260"></canvas>
    </div>
    <div class="card" style="grid-column: span 6;">
      <h3>Deadlines vs Completions</h3>
      <canvas id="tgLine" height="260"></canvas>
    </div>
    <div class="card" style="grid-column: span 6;">
      <h3>Overdue Tasks</h3>
      <ul id="tgOverdue" style="list-style:none; padding:0; margin:0;"></ul>
    </div>
  `;

  await ensureReportDeps();

  // Data derivation
  const tasks = sample.tasksMine || [];
  const users = sample.members || [];
  const isOverdue = (t)=>{ const d = new Date(t.due_date||t.due); return t.status!=='completed' && d.toString()!=='Invalid Date' && d < new Date(); };
  const completed = tasks.filter(t=> (t.status||'').toLowerCase()==='completed').length;
  const total = tasks.length; const pending = Math.max(0, total - completed);

  // Pie chart
  try{
    new Chart(document.getElementById('tgPie'), {
      type: 'pie',
      data: { labels:['Completed','Pending'], datasets:[{ data:[completed, pending], backgroundColor:['#2196f3','#9c27b0'] }]}
    });
  }catch{}

  // Tasks per user (by assignee name)
  const byUser = {};
  tasks.forEach(t=>{ const name = t.assignee_name || t.assignee || 'Unassigned'; byUser[name]=(byUser[name]||0)+1; });
  const barLabels = Object.keys(byUser).slice(0,12);
  const barData = barLabels.map(k=>byUser[k]);
  try{
    new Chart(document.getElementById('tgBar'), {
      type:'bar',
      data:{ labels:barLabels, datasets:[{label:'Tasks', data:barData, backgroundColor:'#00bcd4'}] },
      options:{ scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
    });
  }catch{}

  // Line chart (use simple 4-week buckets)
  const weeks = ['Week 1','Week 2','Week 3','Week 4'];
  const deadlines = [5,6,7,4]; // example look-alike
  const completions = [3,5,6,4];
  try{
    new Chart(document.getElementById('tgLine'), {
      type:'line',
      data:{ labels:weeks, datasets:[
        { label:'Deadlines', data:deadlines, borderColor:'#ff9800', fill:false, tension:.3 },
        { label:'Completions', data:completions, borderColor:'#4caf50', fill:false, tension:.3 }
      ]}
    });
  }catch{}

  // Overdue list
  const over = tasks.filter(isOverdue).slice(0,8);
  const ul = document.getElementById('tgOverdue');
  if (over.length===0){ ul.innerHTML = `<li style="color:var(--muted)">No overdue tasks</li>`; }
  else {
    ul.innerHTML = over.map(t=>{
      const diff = Math.ceil((new Date() - new Date(t.due_date||t.due)) / (1000*60*60*24));
      return `<li class="notif" style="background: rgba(255,93,108,.15); border-left: 4px solid var(--bad);">${t.title} - Due ${diff===1?'Yesterday': diff+ ' days ago'}</li>`;
    }).join('');
  }
}

// Deadline overview
function showDeadlines() {
  sectionTitle.textContent = "Deadlines Calendar";

  cardsMount.innerHTML = `
    <div class="card" style="grid-column:1 / -1;">
      <div class="section-title">
        <h2>Calendar</h2>
        <div class="chips">
          <span class="chip" id="calPrevBtn">Prev</span>
          <span class="chip" id="calTodayBtn">Today</span>
          <span class="chip" id="calNextBtn">Next</span>
          <span class="chip" onclick="renderMain()">Back</span>
        </div>
      </div>
      <div id="calendarHeader" style="text-align:center;margin-bottom:10px;color:var(--muted);"></div>
      <div id="calendarGrid" class="grid" style="grid-template-columns:repeat(7,1fr);gap:8px;"></div>
      <div style="margin-top:10px;color:var(--muted);font-size:12px;">Legend: <span style="color:var(--bad);">Overdue</span> ‚Ä¢ <span style="color:var(--warn);">Due soon</span> ‚Ä¢ <span style="color:var(--ok);">Normal</span></div>
    </div>
  `;

  let offset = 0;

  function getMonthInfo(baseDate, offsetMonths) {
    const d = new Date(baseDate.getFullYear(), baseDate.getMonth() + offsetMonths, 1);
    const year = d.getFullYear();
    const month = d.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    return {year, month, firstDay, daysInMonth, dateObj: d};
  }

  function sameYMD(a,b) {
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }

  function render() {
    const today = new Date();
    const {year, month, firstDay, daysInMonth, dateObj} = getMonthInfo(new Date(), offset);
    const monthName = dateObj.toLocaleString('default', {month:'long'});
    document.getElementById('calendarHeader').textContent = `${monthName} ${year}`;

    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    // Weekday headers
    const weekdays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    weekdays.forEach(w => {
      const h = document.createElement('div');
      h.style.color = 'var(--muted)';
      h.style.fontWeight = '700';
      h.textContent = w;
      grid.appendChild(h);
    });

    // Empty slots before first day
    for (let i=0;i<firstDay;i++){
      const pad = document.createElement('div');
      grid.appendChild(pad);
    }

    // Build a map of deadlines for quick lookup
    const taskDeadlines = {};
    sample.tasksMine.forEach(t=>{
      const dueStr = t.due_date || t.due;
      if (!dueStr) return;
      const d = new Date(dueStr);
      if (d.getFullYear()===year && d.getMonth()===month) {
        const key = d.getDate();
        taskDeadlines[key] = taskDeadlines[key] || [];
        taskDeadlines[key].push(t);
      }
    });

    const projectDeadlines = {};
    sample.projects.forEach(p=>{
      if (!p.deadline) return;
      const d = new Date(p.deadline);
      if (d.getFullYear()===year && d.getMonth()===month) {
        const key = d.getDate();
        projectDeadlines[key] = projectDeadlines[key] || [];
        projectDeadlines[key].push(p);
      }
    });

    // Days
    for (let day=1; day<=daysInMonth; day++){
      const cell = document.createElement('div');
      cell.className = 'card';
      cell.style.padding = '8px';
      cell.style.minHeight = '90px';
      cell.style.display = 'flex';
      cell.style.flexDirection = 'column';
      cell.style.gap = '6px';

      const header = document.createElement('div');
      header.style.display = 'flex';
      header.style.justifyContent = 'space-between';
      header.style.alignItems = 'center';
      const dateObj = new Date(year, month, day);
      header.innerHTML = `<strong>${day}</strong>${sameYMD(dateObj, today) ? '<span class="chip">Today</span>' : ''}`;
      cell.appendChild(header);

      const items = document.createElement('div');
      items.style.display = 'flex';
      items.style.flexDirection = 'column';
      items.style.gap = '4px';

      // Projects first
      (projectDeadlines[day] || []).forEach(p=>{
        const proj = document.createElement('div');
        proj.className = 'pill';
        proj.textContent = `Project: ${p.name}`;
        items.appendChild(proj);
      });

      // Tasks
      (taskDeadlines[day] || []).forEach(t=>{
        const s = getTaskStatus({...t, due: t.due_date || t.due});
        const color = s === 'overdue' ? 'var(--bad)' : s === 'due-soon' ? 'var(--warn)' : 'var(--ok)';
        const task = document.createElement('div');
        task.className = 'pill';
        task.style.borderLeft = `4px solid ${color}`;
        task.style.textOverflow = 'ellipsis';
        task.style.overflow = 'hidden';
        task.style.whiteSpace = 'nowrap';
        task.title = t.title;
        task.textContent = t.title;
        items.appendChild(task);
      });

      if (!(projectDeadlines[day] || []).length && !(taskDeadlines[day] || []).length) {
        const empty = document.createElement('div');
        empty.style.color = 'var(--muted)';
        empty.style.fontSize = '12px';
        empty.textContent = 'No deadlines';
        items.appendChild(empty);
      }

      cell.appendChild(items);
      grid.appendChild(cell);
    }
  }

  document.getElementById('calPrevBtn').addEventListener('click', ()=>{ offset--; render(); });
  document.getElementById('calNextBtn').addEventListener('click', ()=>{ offset++; render(); });
  document.getElementById('calTodayBtn').addEventListener('click', ()=>{ offset = 0; render(); });

  render();
}

// Data export
function exportData() {
  const data = {
    projects: sample.projects,
    tasks: sample.tasksMine,
    members: sample.members,
    profile: sample.profile,
    notifications: sample.notifs,
    exportDate: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataBlob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(dataBlob);
  
  const link = document.createElement('a');
  link.href = url;
  link.download = 'taskgrid-export.json';
  link.click();
  
  showToast('Data exported successfully!', 'success');
}

/* ------- Logout ------- */
function logout(){
  localStorage.clear();
  showToast('Logged out successfully!', 'success');
  setTimeout(() => {
    window.location.href = '../landing page/2-working.html';
  }, 1000);
}

/* ------- Enhanced Search Functionality ------- */
function performSearch() {
  const query = prompt('üîç Search tasks, projects, and users:\n\nEnter keywords to search across:\n‚Ä¢ Task titles and descriptions\n‚Ä¢ Project names\n‚Ä¢ User names\n‚Ä¢ Priorities and statuses');
  
  if (!query || query.trim() === '') {
    return;
  }
  
  const searchTerm = query.toLowerCase().trim();
  const results = {
    tasks: [],
    projects: [],
    members: []
  };
  
  // Search tasks
  results.tasks = sample.tasksMine.filter(task => 
    task.title.toLowerCase().includes(searchTerm) ||
    (task.description && task.description.toLowerCase().includes(searchTerm)) ||
    task.priority.toLowerCase().includes(searchTerm) ||
    task.status.toLowerCase().includes(searchTerm) ||
    (task.project && task.project.toLowerCase().includes(searchTerm))
  );
  
  // Search projects
  results.projects = sample.projects.filter(project => 
    project.name.toLowerCase().includes(searchTerm) ||
    (project.description && project.description.toLowerCase().includes(searchTerm)) ||
    project.status.toLowerCase().includes(searchTerm) ||
    project.priority.toLowerCase().includes(searchTerm)
  );
  
  // Search members
  results.members = sample.members.filter(member => 
    (member.first_name && member.first_name.toLowerCase().includes(searchTerm)) ||
    (member.last_name && member.last_name.toLowerCase().includes(searchTerm)) ||
    (member.name && member.name.toLowerCase().includes(searchTerm)) ||
    member.role.toLowerCase().includes(searchTerm) ||
    (member.email && member.email.toLowerCase().includes(searchTerm))
  );
  
  // Display search results
  displaySearchResults(query, results);
}

function displaySearchResults(query, results) {
  const totalResults = results.tasks.length + results.projects.length + results.members.length;
  
  if (totalResults === 0) {
    showToast(`No results found for "${query}"`, 'info');
    return;
  }
  
  sectionTitle.textContent = `Search Results for "${query}"`;
  
  let resultsHTML = `
    <div class="card" style="grid-column: 1 / -1;">
      <div class="section-title">
        <h2>Search Results (${totalResults} found)</h2>
        <span class="chip" onclick="renderMain()">Back to Dashboard</span>
      </div>
      <div style="margin-bottom: 20px;">
        <span style="color: var(--muted);">
          Found ${results.tasks.length} tasks, ${results.projects.length} projects, ${results.members.length} users
        </span>
      </div>
    </div>
  `;
  
  // Display task results
  if (results.tasks.length > 0) {
    resultsHTML += `
      <div class="card" style="grid-column: 1 / -1;">
        <div class="section-title">
          <h2>üìã Tasks (${results.tasks.length})</h2>
        </div>
        <div style="display: grid; gap: 10px;">
          ${results.tasks.map(task => `
            <div class="notif" onclick="highlightTask(${task.id})" style="cursor: pointer;">
              <span class="dot ${getTaskStatus(task) === 'overdue' ? 'bad' : getTaskStatus(task) === 'due-soon' ? 'warn' : 'ok'}"></span>
              <div style="flex: 1;">
                <div><strong>${task.title}</strong></div>
                <div style="color: var(--muted); font-size: 12px;">
                  ${task.project} ‚Ä¢ Due: ${formatDate(task.due_date || task.due)} ‚Ä¢ Priority: ${task.priority}
                </div>
                ${task.description ? `<div style="color: var(--muted); font-size: 11px; margin-top: 4px;">${task.description.substring(0, 100)}${task.description.length > 100 ? '...' : ''}</div>` : ''}
              </div>
              <span class="pill">${task.status}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // Display project results
  if (results.projects.length > 0) {
    resultsHTML += `
      <div class="card" style="grid-column: 1 / -1;">
        <div class="section-title">
          <h2>üìÅ Projects (${results.projects.length})</h2>
        </div>
        <div style="display: grid; gap: 10px;">
          ${results.projects.map(project => `
            <div class="notif" onclick="highlightProject(${project.id})" style="cursor: pointer;">
              <span class="dot ok"></span>
              <div style="flex: 1;">
                <div><strong>${project.name}</strong></div>
                <div style="color: var(--muted); font-size: 12px;">
                  Status: ${project.status} ‚Ä¢ Priority: ${project.priority}
                  ${project.deadline ? ` ‚Ä¢ Deadline: ${formatDate(project.deadline)}` : ''}
                </div>
                ${project.description ? `<div style="color: var(--muted); font-size: 11px; margin-top: 4px;">${project.description.substring(0, 100)}${project.description.length > 100 ? '...' : ''}</div>` : ''}
              </div>
              <span class="pill">${project.status}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  // Display member results
  if (results.members.length > 0) {
    resultsHTML += `
      <div class="card" style="grid-column: 1 / -1;">
        <div class="section-title">
          <h2>üë• Team Members (${results.members.length})</h2>
        </div>
        <div style="display: grid; gap: 10px;">
          ${results.members.map(member => `
            <div class="notif" style="cursor: pointer;">
              <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, var(--accent1), var(--accent2)); display: grid; place-items: center; font-size: 12px; font-weight: 800;">
                ${(member.first_name?.[0] || '') + (member.last_name?.[0] || '') || member.name?.[0] || 'U'}
              </div>
              <div style="flex: 1;">
                <div><strong>${member.first_name ? `${member.first_name} ${member.last_name}` : member.name || 'Unknown'}</strong></div>
                <div style="color: var(--muted); font-size: 12px;">
                  Role: ${member.role} ${member.email ? `‚Ä¢ ${member.email}` : ''}
                </div>
              </div>
              <span class="pill">${member.role}</span>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  
  cardsMount.innerHTML = resultsHTML;
  showToast(`Found ${totalResults} results for "${query}"`, 'success');
}

function highlightTask(taskId) {
  const task = sample.tasksMine.find(t => t.id === taskId);
  if (task) {
    showToast(`üìã Task: ${task.title}\nProject: ${task.project}\nDue: ${formatDate(task.due_date || task.due)}\nStatus: ${task.status}`, 'info');
  }
}

function highlightProject(projectId) {
  const project = sample.projects.find(p => p.id === projectId);
  if (project) {
    showToast(`üìÅ Project: ${project.name}\nStatus: ${project.status}\nPriority: ${project.priority}${project.deadline ? `\nDeadline: ${formatDate(project.deadline)}` : ''}`, 'info');
  }
}

/* ------- Initialize ------- */
document.addEventListener('DOMContentLoaded', async function() {
  // Load user data from backend
  await loadUserData();
  await loadUserProfile();
  
  // Add enhanced search functionality
  document.getElementById('searchBtn').onclick = performSearch;
  
  // Update notifications on load
  setTimeout(updateNotifications, 1000);
  
  // Auto-refresh notifications every minute
  setInterval(updateNotifications, 60000);
  
  // Auto-save data every 30 seconds
  setInterval(() => saveUserData(sample), 30000);
  
  // Auto-refresh data from server every 5 minutes
  setInterval(async () => {
    try {
      await loadUserData();
      console.log('Data refreshed from server');
    } catch (error) {
      console.log('Failed to refresh data from server');
    }
  }, 300000); // 5 minutes
  
  console.log('‚úÖ TaskGrid Dashboard loaded with backend integration!');
  console.log('‚úÖ Enhanced search functionality implemented!');
  console.log('‚úÖ All tasks require start date and due date!');
  console.log('‚úÖ Data automatically syncs with server!');
});
</script>
</body>
</html>